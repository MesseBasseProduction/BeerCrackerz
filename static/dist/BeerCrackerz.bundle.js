!function(){"use strict";var e={d:function(t,r){for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}},t={};function r(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}e.d(t,{default:function(){return z}});var n=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._csrfToken=this._getCsrfCookie(),this._headers=this._createRequestHeaders(),this.isValid=this._checkValidity()}var t,n;return t=e,n=[{key:"_getCsrfCookie",value:function(){if(document.cookie&&""!==document.cookie)for(var e=document.cookie.split(";"),t=0;t<e.length;++t){var r=e[t].split("=");if(void 0!==r&&r[0].toLowerCase().includes("srf"))return decodeURIComponent(r[1])}return null}},{key:"_createRequestHeaders",value:function(){return[["Content-Type","application/json; charset=UTF-8"],["Accept","application/json"],["X-CSRFToken",this._csrfToken]]}},{key:"_checkValidity",value:function(){return null!==this._csrfToken&&3===this._headers.length}},{key:"_resolveAs",value:function(e,t){return new Promise((function(r,n){t?"raw"===e?200===t.status?r(t.responseText):n(t.status):"json"===e||"text"===e?t[e]?r(t[e]()):n(t.status):"dom"===e?t.text().then((function(e){r(document.createRange().createContextualFragment(e))})).catch(n):r():n("F_KOM_MISSING_ARGUMENT")}))}},{key:"_resolveAsJSON",value:function(e){return this._resolveAs("json",e)}},{key:"_resolveAsText",value:function(e){return this._resolveAs("text",e)}},{key:"_resolveAsDom",value:function(e){return this._resolveAs("dom",e)}},{key:"get",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._resolveAsJSON.bind(this);return new Promise((function(n,i){var o={method:"GET",headers:new Headers([t._headers[0]])};fetch(e,o).then((function(e){return 200!==e.status&&i(e),r(e)})).then(n).catch(i)}))}},{key:"getText",value:function(e){return this.get(e,this._resolveAsText.bind(this))}},{key:"getTemplate",value:function(e){return this.get(e,this._resolveAsDom.bind(this))}},{key:"post",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._resolveAsJSON.bind(this);return new Promise((function(i,o){var a={method:"POST",headers:new Headers(r._headers),body:JSON.stringify(t)};fetch(e,a).then((function(e){return e.status>=400&&o(e),null!=n?n(e):e})).then(i).catch(o)}))}},{key:"postText",value:function(e,t){return this.post(e,t,this._resolveAsText.bind(this))}},{key:"postImage",value:function(e,t){return this.post(e,t,null)}},{key:"patch",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._resolveAsJSON.bind(this);return new Promise((function(i,o){var a={method:"PATCH",headers:new Headers(r._headers),body:JSON.stringify(t)};fetch(e,a).then((function(e){return e.status>=400&&o(e),null!=n?n(e):e})).then(i).catch(o)}))}},{key:"patchImage",value:function(e,t){return this.patch(e,t,null)}},{key:"delete",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._resolveAsJSON.bind(this);return new Promise((function(i,o){var a={method:"DELETE",headers:new Headers(r._headers),body:JSON.stringify(t)};fetch(e,a).then((function(e){return e.status>=400&&o(e),null!=n?n(e):e})).then(i).catch(o)}))}},{key:"_getMarks",value:function(e){var t=this;return new Promise((function(r,n){t.get("http://localhost:8080/api/".concat(e)).then(r).catch(n)}))}},{key:"getSpots",value:function(){return this._getMarks("spot")}},{key:"getShops",value:function(){return this._getMarks("shop")}},{key:"getBars",value:function(){return this._getMarks("bar")}},{key:"_saveMark",value:function(e,t){var r=this;return new Promise((function(n,i){r.post("http://localhost:8080/api/".concat(e,"/"),t,null).then(n).catch(i)}))}},{key:"spotCreated",value:function(e){return this._saveMark("spot",e)}},{key:"shopCreated",value:function(e){return this._saveMark("shop",e)}},{key:"barCreated",value:function(e){return this._saveMark("bar",e)}},{key:"_editMark",value:function(e,t,r){var n=this;return new Promise((function(i,o){n.patch("http://localhost:8080/api/".concat(e,"/").concat(t,"/"),r,null).then(i).catch(o)}))}},{key:"spotEdited",value:function(e,t){return this._editMark("spot",e,t)}},{key:"shopEdited",value:function(e,t){return this._editMark("shop",e,t)}},{key:"barEdited",value:function(e,t){return this._editMark("bar",e,t)}},{key:"_deleteMark",value:function(e,t,r){var n=this;return new Promise((function(i,o){n.delete("http://localhost:8080/api/".concat(e,"/").concat(t,"/"),r,null).then(i).catch(o)}))}},{key:"spotDeleted",value:function(e,t){return this._deleteMark("spot",e,t)}},{key:"shopDeleted",value:function(e,t){return this._deleteMark("shop",e,t)}},{key:"barDeleted",value:function(e,t){return this._deleteMark("bar",e,t)}},{key:"csrf",get:function(){return null}}],n&&r(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),e}(),i=n;function o(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r;return t=e,r=[{key:"stripDom",value:function(e){return(new DOMParser).parseFromString(e,"text/html").body.textContent||""}},{key:"replaceString",value:function(e,t,r){e.innerHTML=e.innerHTML.replace(t,r)}},{key:"getDistanceBetweenCoords",value:function(e,t){var r=e[1]*Math.PI/180,n=e[0]*Math.PI/180,i=t[1]*Math.PI/180,o=t[0]*Math.PI/180,a=o-n,s=i-r,c=Math.pow(Math.sin(a/2),2)+Math.cos(n)*Math.cos(o)*Math.pow(Math.sin(s/2),2);return 2*Math.asin(Math.sqrt(c))*6371*1e3}},{key:"precisionRound",value:function(e,t){var r=Math.pow(10,t||0);return Math.round(e*r)/r}},{key:"initDebugInterface",value:function(){var e=window.BeerCrackerz.nls.debug.bind(window.BeerCrackerz.nls),t=document.createElement("DIV"),r=document.createElement("P"),n=document.createElement("P"),i=document.createElement("P"),o=document.createElement("P"),a=document.createElement("P"),s=document.createElement("P"),c=document.createElement("P"),l=document.createElement("P"),u=document.createElement("P"),d=document.createElement("BUTTON");return t.classList.add("debug-container"),r.classList.add("debug-user-lat"),n.classList.add("debug-user-lng"),i.classList.add("debug-updates-amount"),o.classList.add("debug-user-accuracy"),a.classList.add("debug-high-accuracy"),s.classList.add("debug-pos-max-age"),c.classList.add("debug-pos-timeout"),l.classList.add("debug-zoom-level"),u.classList.add("debug-marks-amount"),d.classList.add("debug-export-data"),r.innerHTML="<b>".concat(e("lat"),"</b> : -"),n.innerHTML="<b>".concat(e("lng"),"</b> : -"),i.innerHTML="<b>".concat(e("updates"),"</b> : 0"),o.innerHTML="<b>".concat(e("accuracy"),"</b> : -"),a.innerHTML="<b>".concat(e("highAccuracy"),"</b> : -"),s.innerHTML="<b>".concat(e("posAge"),"</b> : -"),c.innerHTML="<b>".concat(e("posTimeout"),"</b> : -"),l.innerHTML="<b>".concat(e("zoom"),"</b> : -"),u.innerHTML="<b>".concat(e("marks"),"</b> : -"),d.innerHTML=e("export"),t.appendChild(r),t.appendChild(n),t.appendChild(i),t.appendChild(o),t.appendChild(a),t.appendChild(s),t.appendChild(c),t.appendChild(l),t.appendChild(u),t.appendChild(d),d.addEventListener("click",window.BeerCrackerz.downloadData.bind(window.BeerCrackerz)),t}},{key:"updateDebugInterface",value:function(t,r,n){if(!0===window.DEBUG){var i=window.BeerCrackerz,o=i.nls.debug.bind(i.nls),a=parseInt(t.querySelector(".debug-updates-amount").innerHTML.split(" : ")[1])+1,s=i.marks.spot.length+i.marks.shop.length+i.marks.bar.length;t.querySelector(".debug-user-lat").innerHTML="\n        <b>".concat(o("lat"),"</b> : ").concat(r.lat,"\n      "),t.querySelector(".debug-user-lng").innerHTML="\n        <b>".concat(o("lng"),"</b> : ").concat(r.lng,"\n      "),t.querySelector(".debug-updates-amount").innerHTML="\n        <b>".concat(o("updates"),"</b> : ").concat(a,"\n      "),t.querySelector(".debug-user-accuracy").innerHTML="\n        <b>".concat(o("accuracy"),"</b> : ").concat(e.precisionRound(r.accuracy,2),"m\n      "),t.querySelector(".debug-high-accuracy").innerHTML="\n        <b>".concat(o("highAccuracy"),"</b> : ").concat(!0===n.enableHighAccuracy?o("enabled"):o("disabled"),"\n      "),t.querySelector(".debug-pos-max-age").innerHTML="\n        <b>".concat(o("posAge"),"</b> : ").concat(n.maximumAge/1e3,"s\n      "),t.querySelector(".debug-pos-timeout").innerHTML="\n        <b>".concat(o("posTimeout"),"</b> : ").concat(n.timeout/1e3,"s\n      "),t.querySelector(".debug-zoom-level").innerHTML="\n        <b>".concat(o("zoom"),"</b> : ").concat(i.map.getZoom(),"\n      "),t.querySelector(".debug-marks-amount").innerHTML="\n        <b>".concat(o("marks"),"</b> : ").concat(s,"\n      ")}}},{key:"getPreference",value:function(e){return localStorage.getItem(e)||null}},{key:"setPreference",value:function(e,t){localStorage.setItem(e,t)}},{key:"RANGE_COLOR",get:function(){return"#ffd87d"}},{key:"USER_COLOR",get:function(){return"#63fff5"}},{key:"SPOT_COLOR",get:function(){return"#26ad23"}},{key:"SHOP_COLOR",get:function(){return"#247dc9"}},{key:"BAR_COLOR",get:function(){return"#ca2a3d"}},{key:"CIRCLE_RADIUS",get:function(){return 100}},{key:"NEW_MARKER_RANGE",get:function(){return 200}},{key:"MAP_BOUNDS",get:function(){return window.L.latLngBounds(window.L.latLng(-89.98155760646617,-180),window.L.latLng(89.99346179538875,180))}},{key:"HIGH_ACCURACY",get:function(){return{enableHighAccuracy:!0,maximumAge:1e3,timeout:900}}},{key:"OPTIMIZED_ACCURACY",get:function(){return{enableHighAccuracy:!1,maximumAge:3e4,timeout:29e3}}},{key:"SUPPORTED_LANGUAGE",get:function(){return["en","fr","es","de","pt"]}}],null&&o(t.prototype,null),r&&o(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var c=function(){function e(t,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._lang=-1!==a.SUPPORTED_LANGUAGE.indexOf(t)?t:"en",this._fullLang=t,this._values={},this._init().then(r).catch(n)}var t,r;return t=e,(r=[{key:"_init",value:function(){var e=this;return new Promise((function(t,r){fetch("/static/nls/".concat(e._lang,".json")).then((function(n){200!==n.status&&(n.msg="Fetching the i18n file failed",r(n)),n.text().then((function(i){try{e._values=JSON.parse(i)}catch(e){n.msg="Parsing the i18n file failed",r(n)}t()})).catch(r)})).catch(r)}))}},{key:"debug",value:function(e){return this._values.debug[e]||""}},{key:"notif",value:function(e){return this._values.notif[e]||""}},{key:"nav",value:function(e){return this._values.nav[e]||""}},{key:"map",value:function(e){return this._values.map[e]||""}},{key:"spot",value:function(e){return this._values.spot[e]||""}},{key:"shop",value:function(e){return this._values.shop[e]||""}},{key:"bar",value:function(e){return this._values.bar[e]||""}},{key:"popup",value:function(e){return this._values.popup[e]||""}},{key:"modal",value:function(e){return this._values.modal[e]||""}},{key:"login",value:function(e){return this._values.auth.login[e]||""}},{key:"register",value:function(e){return this._values.auth.register[e]||""}},{key:"forgotPassword",value:function(e){return this._values.auth.forgotPassword[e]||""}},{key:"resetPassword",value:function(e){return this._values.auth.resetPassword[e]||""}},{key:"fullLang",get:function(){return this._fullLang}}])&&s(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),l=Object.freeze({blue:new window.L.Icon({iconUrl:"/static/img/marker/marker-icon-blue.png",shadowUrl:"/static/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),gold:new window.L.Icon({iconUrl:"/static/img/marker/marker-icon-gold.png",shadowUrl:"/static/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),red:new window.L.Icon({iconUrl:"/static/img/marker/marker-icon-red.png",shadowUrl:"/static/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),green:new window.L.Icon({iconUrl:"/static/img/marker/marker-icon-green.png",shadowUrl:"/static/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),orange:new window.L.Icon({iconUrl:"/static/img/marker/marker-icon-orange.png",shadowUrl:"/static/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),yellow:new window.L.Icon({iconUrl:"/static/img/marker/marker-icon-yellow.png",shadowUrl:"/static/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),violet:new window.L.Icon({iconUrl:"/static/img/marker/marker-icon-violet.png",shadowUrl:"/static/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),grey:new window.L.Icon({iconUrl:"/static/img/marker/marker-icon-grey.png",shadowUrl:"/static/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),black:new window.L.Icon({iconUrl:"/static/img/marker/marker-icon-black.png",shadowUrl:"/static/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),user:new window.L.Icon({iconUrl:"/static/img/marker/user-position.png",shadowUrl:"/static/img/marker/user-position-shadow.png",iconSize:[32,32],iconAnchor:[16,16],popupAnchor:[1,-34],shadowSize:[32,32]})});function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var d=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._container=null,this._items=[],this._currentRate=r||0,this._clicked=r||-1,this._init(t),this._events()}var t,r;return t=e,(r=[{key:"_init",value:function(e){this._container=e;for(var t=0;t<e.children.length;++t)this._items.push(e.children[t]);for(var r=0;r<this._currentRate+1;++r)this._items[r].classList.add("active"),this._items[r].classList.add("selected")}},{key:"_events",value:function(){this._container.addEventListener("mouseover",this._containerHovered.bind(this),!1),this._container.addEventListener("mouseout",this._pointerExit.bind(this),!1);for(var e=0;e<this._items.length;++e)this._items[e].addEventListener("click",this._starClicked.bind(this),!1)}},{key:"_containerHovered",value:function(e){"IMG"===e.target.tagName&&(this._currentRate=parseInt(e.target.dataset.id),this._container.dataset.rate=this._currentRate,this.updateStars())}},{key:"_pointerExit",value:function(){this._currentRate=-1===this._clicked?0:this._clicked,this._container.dataset.rate=this._currentRate,this.updateStars()}},{key:"_starClicked",value:function(e){this._currentRate=parseInt(e.target.dataset.id),this._container.dataset.rate=this._currentRate,this._clicked=this._currentRate,this.updateStars()}},{key:"updateStars",value:function(){for(var e=0;e<this._items.length;++e)e<=this._currentRate?(this._items[e].classList.add("active"),e<=this._clicked&&this._items[e].classList.add("selected")):(this._items[e].classList.remove("active"),this._items[e].classList.remove("selected"))}},{key:"currentRate",get:function(){return this._currentRate}}])&&u(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function h(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r;return t=e,(r=[{key:"placeMarker",value:function(e){var t=this,r=l.black;"shop"===e.type?r=l.blue:"spot"===e.type?r=l.green:"bar"===e.type?r=l.red:"user"===e.type&&(r=l.user);var n=window.L.marker([e.lat,e.lng],{icon:r}).on("click",(function(){"true"===a.getPreference("map-center-on-user")&&t.toggleFocusLock(),t.map.flyTo([e.lat,e.lng],18)}));return e.dom&&n.bindPopup(e.dom),-1===["spot","shop","bar"].indexOf(e.type)&&n.addTo(this.map),n}},{key:"drawUserMarker",value:function(){this.user.marker?(this.user.marker.setLatLng(this.user),this.user.range.setLatLng(this.user),this.user.circle.setLatLng(this.user),this.user.circle.setRadius(this.user.accuracy)):(this.user.type="user",this.user.marker=this.placeMarker(this.user),this.user.radius=this.user.accuracy,this.user.circle=this.drawCircle(this.user),this.user.range=this.drawCircle({lat:this.user.lat,lng:this.user.lng,radius:a.NEW_MARKER_RANGE,color:a.RANGE_COLOR}),"true"===a.getPreference("poi-show-circle")&&(this.user.circle.setStyle({opacity:1,fillOpacity:.1}),this.user.range.setStyle({opacity:1,fillOpacity:.1})),this.user.marker.on("click",this.mapClicked.bind(this)))}},{key:"definePOI",value:function(e,t){var r=this,n={wrapper:document.createElement("DIV"),title:document.createElement("P"),spot:document.createElement("BUTTON"),shop:document.createElement("BUTTON"),bar:document.createElement("BUTTON")};n.wrapper.className="new-poi",n.title.innerHTML=this.nls.map("newTitle"),n.spot.innerHTML=this.nls.map("newSpot"),n.shop.innerHTML=this.nls.map("newShop"),n.bar.innerHTML=this.nls.map("newBar"),n.spot.dataset.type="spot",n.shop.dataset.type="shop",n.bar.dataset.type="bar",n.wrapper.appendChild(n.title),n.wrapper.appendChild(n.spot),n.wrapper.appendChild(n.shop),n.wrapper.appendChild(n.bar),e.dom=n.wrapper;var i=this.placeMarker(e).openPopup();e.marker=i,e.addedCallback=t;var o=function(t){i.isBeingDefined=!0,i.closePopup(),r.defineMarkFactory(t.target.dataset.type,e)};return n.spot.addEventListener("click",o),n.shop.addEventListener("click",o),n.bar.addEventListener("click",o),i.on("popupclose",(function(){i.isBeingDefined||(i.popupClosed=!0,i.removeFrom(r.map))})),i}},{key:"defineMarkFactory",value:function(e,t){var r=this;this._kom.getTemplate("/modal/new".concat(e)).then((function(n){var i=n.querySelector("#".concat(e,"-name")),o=n.querySelector("#".concat(e,"-desc")),s=new d(n.querySelector("#".concat(e,"-rating"))),c=n.querySelector("#".concat(e,"-submit")),l=n.querySelector("#".concat(e,"-cancel")),u=n.querySelector("#modal-close");a.replaceString(n.querySelector("#nls-".concat(e,"-title")),"{".concat(e.toUpperCase(),"_TITLE}"),r.nls[e]("title")),a.replaceString(n.querySelector("#nls-".concat(e,"-subtitle")),"{".concat(e.toUpperCase(),"_SUBTITLE}"),r.nls[e]("subtitle")),a.replaceString(n.querySelector("#nls-".concat(e,"-name")),"{".concat(e.toUpperCase(),"_NAME}"),r.nls[e]("nameLabel")),a.replaceString(n.querySelector("#nls-".concat(e,"-desc")),"{".concat(e.toUpperCase(),"_DESC}"),r.nls[e]("descLabel")),a.replaceString(n.querySelector("#nls-".concat(e,"-rate")),"{".concat(e.toUpperCase(),"_RATE}"),r.nls[e]("rateLabel")),a.replaceString(c,"{".concat(e.toUpperCase(),"_SUBMIT}"),r.nls.nav("add")),a.replaceString(l,"{".concat(e.toUpperCase(),"_CANCEL}"),r.nls.nav("cancel"));var h=function(){t.marker.isBeingDefined=!1,t.marker.removeFrom(r.map),r.closeModal(null,!0)};c.addEventListener("click",(function(){""===i.value?r._notification.raise(r.nls.notif("markNameEmpty")):(h(),t.type=e,t.name=i.value,t.description=o.value,t.rate=s.currentRate,r.markPopupFactory(t).then((function(e){t.dom=e,t.marker=r.placeMarker(t),t.addedCallback(t)})))})),l.addEventListener("click",h),u.addEventListener("click",h),r.newMarkModal(n)}))}},{key:"defineNewSpot",value:function(e){this.defineMarkFactory("spot",e)}},{key:"defineNewShop",value:function(e){this.defineMarkFactory("shop",e)}},{key:"defineNewBar",value:function(e){this.defineMarkFactory("bar",e)}},{key:"markPopupFactory",value:function(e){var t=this;return new Promise((function(r){t._kom.getTemplate("/popup/".concat(e.type)).then((function(n){var i=document.createElement("DIV");i.appendChild(n);var o=e.user||t.user.username,s=a.stripDom(e.description)||t.nls.popup("".concat(e.type,"NoDesc"));e.creationDate||(e.creationDate=(new Date).toISOString().slice(0,10));var c=new Intl.DateTimeFormat(t.nls.fullLang,{dateStyle:"long"}).format(new Date(e.creationDate));a.replaceString(i,"{".concat(e.type.toUpperCase(),"_NAME}"),a.stripDom(e.name)),a.replaceString(i,"{".concat(e.type.toUpperCase(),"_FINDER}"),o),a.replaceString(i,"{".concat(e.type.toUpperCase(),"_FOUND_BY}"),t.nls.popup("".concat(e.type,"FoundBy"))),a.replaceString(i,"{".concat(e.type.toUpperCase(),"_FOUND_WHEN}"),t.nls.popup("".concat(e.type,"FoundWhen"))),a.replaceString(i,"{".concat(e.type.toUpperCase(),"_FOUND_DATE}"),c),a.replaceString(i,"{".concat(e.type.toUpperCase(),"_RATE}"),e.rate+1),a.replaceString(i,"{".concat(e.type.toUpperCase(),"_DESC}"),s);for(var l=i.querySelector("#".concat(e.type,"-rating")),u=0;u<e.rate+1;++u)l.children[u].classList.add("active");a.getDistanceBetweenCoords([t.user.lat,t.user.lng],[e.lat,e.lng])>a.CIRCLE_RADIUS&&i.querySelector("#popup-social").parentNode.removeChild(i.querySelector("#popup-social")),o!==t.user.username?i.querySelector("#popup-edit").parentNode.removeChild(i.querySelector("#popup-edit")):(i.querySelector("#edit-mark").addEventListener("click",t.editMarker.bind(t,e),!1),i.querySelector("#delete-mark").addEventListener("click",t.deleteMarker.bind(t,e),!1)),e.color=a["".concat(e.type.toUpperCase(),"_COLOR")],e.circle=t.drawCircle(e),e.tooltip=window.L.tooltip({permanent:!0,direction:"center",className:"marker-tooltip",interactive:!0}).setContent(e.name).setLatLng(e.circle.getLatLng()),"true"===a.getPreference("poi-marker-label")&&e.tooltip.addTo(t.map),r(i)}))}))}},{key:"drawCircle",value:function(e){return window.L.circle(e,{color:e.color,fillColor:e.color,opacity:0,fillOpacity:0,radius:e.radius?e.radius:a.CIRCLE_RADIUS}).addTo(this.map)}},{key:"setMarkerCircles",value:function(e,t){for(var r=0;r<e.length;++r)t?(e[r].circle.setStyle({opacity:1,fillOpacity:.1}),e[r].circle.addTo(this.map)):(e[r].circle.setStyle({opacity:0,fillOpacity:0}),e[r].circle.removeFrom(this.map))}},{key:"setMarkerLabels",value:function(e,t){for(var r=0;r<e.length;++r)t?e[r].tooltip.addTo(this.map):e[r].tooltip.removeFrom(this.map)}}])&&h(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function m(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var g=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._map=t,this._container=document.querySelector("#zoom-slider"),this._slider=document.querySelector("#slider-position"),this._zoomRange=this._map.getMaxZoom()-this._map.getMinZoom(),this._timeoutId=-1,this._events()}var t,r;return t=e,(r=[{key:"_events",value:function(){var e=this;this._map.on("zoomstart",(function(){clearTimeout(e._timeoutId),e._timeoutId=-1,e._container.classList.add("opened")})),this._map.on("zoomend",(function(){var t=e._map.getZoom()-e._map.getMinZoom();e._slider.style.height="".concat(100*t/e._zoomRange,"%"),e._timeoutId=setTimeout((function(){return e._container.classList.remove("opened")}),1500)})),this._map.on("zoom",(function(){clearTimeout(e._timeoutId),e._timeoutId=-1;var t=e._map.getZoom()-e._map.getMinZoom();e._slider.style.height="".concat(100*t/e._zoomRange,"%")})),this._container.addEventListener("mouseover",(function(){clearTimeout(e._timeoutId),e._timeoutId=-1})),this._container.addEventListener("mouseleave",(function(){e._timeoutId=setTimeout((function(){return e._container.classList.remove("opened")}),1500)})),this._container.querySelector("#zoom-more").addEventListener("click",(function(){e._map.setZoom(e._map.getZoom()+1)})),this._container.querySelector("#zoom-less").addEventListener("click",(function(){e._map.setZoom(e._map.getZoom()-1)}))}}])&&m(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function y(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var f=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._container=document.querySelector("#notification-wrapper"),this._message=document.querySelector("#notification-message"),this._timeoutId=null}var t,r;return t=e,(r=[{key:"raise",value:function(e){var t=this;clearTimeout(this._timeoutId),this._message.innerHTML=e,this._container.classList.add("opened"),this._timeoutId=setTimeout((function(){t._container.classList.remove("opened"),t._message.innerHTML=""}),2e3)}}])&&y(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function _(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var v=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._dom={wrapper:t.wrapper,container:null,resizer:null,tl:null,tr:null,br:null,bl:null,l:null,t:null,r:null,b:null},this._grab={tl:!1,tr:!1,br:!1,bl:!1,l:!1,t:!1,r:!1,b:!1},this._min={x:0,y:0},this._max={x:500,y:500},this.containerRect={},this.resizerRect={},this._buildUI(),this._events()}var t,r;return t=e,(r=[{key:"_buildUI",value:function(){this._dom.wrapper.classList.add("image-resizer"),this._dom.container=document.createElement("DIV"),this._dom.resizer=document.createElement("DIV"),this._dom.tl=document.createElement("DIV"),this._dom.tr=document.createElement("DIV"),this._dom.br=document.createElement("DIV"),this._dom.bl=document.createElement("DIV"),this._dom.l=document.createElement("DIV"),this._dom.t=document.createElement("DIV"),this._dom.r=document.createElement("DIV"),this._dom.b=document.createElement("DIV"),this._dom.container.classList.add("container"),this._dom.resizer.classList.add("resizer"),this._dom.tl.classList.add("tl-grab"),this._dom.tl.dataset.loc="tl",this._dom.tr.classList.add("tr-grab"),this._dom.tr.dataset.loc="tr",this._dom.br.classList.add("br-grab"),this._dom.br.dataset.loc="br",this._dom.bl.classList.add("bl-grab"),this._dom.bl.dataset.loc="bl",this._dom.l.classList.add("l-grab"),this._dom.l.dataset.loc="l",this._dom.t.classList.add("t-grab"),this._dom.t.dataset.loc="t",this._dom.r.classList.add("r-grab"),this._dom.r.dataset.loc="r",this._dom.b.classList.add("b-grab"),this._dom.b.dataset.loc="b",this._dom.resizer.appendChild(this._dom.tl),this._dom.resizer.appendChild(this._dom.tr),this._dom.resizer.appendChild(this._dom.br),this._dom.resizer.appendChild(this._dom.bl),this._dom.resizer.appendChild(this._dom.l),this._dom.resizer.appendChild(this._dom.t),this._dom.resizer.appendChild(this._dom.r),this._dom.resizer.appendChild(this._dom.b),this._dom.wrapper.appendChild(this._dom.container),this._dom.wrapper.appendChild(this._dom.resizer)}},{key:"_events",value:function(){this._dom.resizer.addEventListener("mousedown",this._mouseDown.bind(this)),document.body.addEventListener("mousemove",this._mouseMove.bind(this)),document.body.addEventListener("mouseup",this._mouseUp.bind(this))}},{key:"_mouseDown",value:function(e){-1!==Object.keys(this._grab).indexOf(e.target.dataset.loc)&&(this._grab[e.target.dataset.loc]=!0,this.containerRect=this._dom.container.getBoundingClientRect(),this.resizerRect=this._dom.resizer.getBoundingClientRect())}},{key:"_mouseMove",value:function(e){if(this._isGrabbed()){var t=e.pageX-this.containerRect.x,r=e.pageY-this.containerRect.y;t<0&&(t=0),t>this.containerRect.width&&(t=this.containerRect.width),r<0&&(r=0),r>this.containerRect.height&&(r=this.containerRect.height);var n=this.resizerRect.x-this.containerRect.x,i=this.resizerRect.y-this.containerRect.y,o=this.resizerRect.x+this.resizerRect.width-this.containerRect.x,a=this.resizerRect.y+this.resizerRect.height-this.containerRect.y;if(this._grab.tl){if(i+(t-n)<0){var s=this._dom.resizer.style.top.slice(0,-2);return this._dom.resizer.style.top=0,void(this._dom.resizer.style.left=this._dom.resizer.style.left.slice(0,-2)-s)}this._dom.resizer.style.left=n+(t-n),this._dom.resizer.style.top=i+(t-n)}else if(this._grab.tr){if(i+(o-t)<0){var c=this._dom.resizer.style.top.slice(0,-2);return this._dom.resizer.style.top=0,void(this._dom.resizer.style.right=this._dom.resizer.style.right.slice(0,-2)-c)}this._dom.resizer.style.right=this.containerRect.width-o+o-t,this._dom.resizer.style.top=i+(o-t)}else if(this._grab.br){if(this.containerRect.height-a+o-t<0){var l=this._dom.resizer.style.bottom.slice(0,-2);return this._dom.resizer.style.bottom=0,void(this._dom.resizer.style.right=this._dom.resizer.style.right.slice(0,-2)-l)}this._dom.resizer.style.right=this.containerRect.width-o+o-t,this._dom.resizer.style.bottom=this.containerRect.height-a+o-t}else if(this._grab.bl){if(this.containerRect.height-a+(t-n)<0){var u=this._dom.resizer.style.bottom.slice(0,-2);return this._dom.resizer.style.bottom=0,void(this._dom.resizer.style.left=this._dom.resizer.style.left.slice(0,-2)-u)}this._dom.resizer.style.left=n+(t-n),this._dom.resizer.style.bottom=this.containerRect.height-a+(t-n)}else if(this._grab.l){if(i+(t-n)/2<0){var d=this._dom.resizer.style.top.slice(0,-2);return this._dom.resizer.style.top=0,this._dom.resizer.style.left=this._dom.resizer.style.left.slice(0,-2)-d,void(this._dom.resizer.style.bottom=this._dom.resizer.style.bottom.slice(0,-2)-d)}if(this.containerRect.height-a+(t-n)/2<0){var h=this._dom.resizer.style.bottom.slice(0,-2);return this._dom.resizer.style.bottom=0,this._dom.resizer.style.top=this._dom.resizer.style.top.slice(0,-2)-h/2,void(this._dom.resizer.style.left=this._dom.resizer.style.left.slice(0,-2)-h/2)}this._dom.resizer.style.left=n+(t-n),this._dom.resizer.style.bottom=this.containerRect.height-a+(t-n)/2,this._dom.resizer.style.top=i+(t-n)/2}else if(this._grab.t){if(n+(r-i)/2<0){var p=this._dom.resizer.style.left.slice(0,-2);return this._dom.resizer.style.left=0,this._dom.resizer.style.right=this._dom.resizer.style.right.slice(0,-2)-p/2,void(this._dom.resizer.style.top=this._dom.resizer.style.top.slice(0,-2)-p/2)}if(this.containerRect.width-o+(r-i)/2<0){var m=this._dom.resizer.style.right.slice(0,-2);return this._dom.resizer.style.right=0,this._dom.resizer.style.top=this._dom.resizer.style.top.slice(0,-2)-m/2,void(this._dom.resizer.style.left=this._dom.resizer.style.left.slice(0,-2)-m/2)}this._dom.resizer.style.top=i+(r-i),this._dom.resizer.style.left=n+(r-i)/2,this._dom.resizer.style.right=this.containerRect.width-o+(r-i)/2}else if(this._grab.r){if(i+(o-t)/2<0){var g=this._dom.resizer.style.top.slice(0,-2);return this._dom.resizer.style.top=0,this._dom.resizer.style.right=this._dom.resizer.style.right.slice(0,-2)-g/2,void(this._dom.resizer.style.bottom=this._dom.resizer.style.bottom.slice(0,-2)-g/2)}if(this.containerRect.height-a+(o-t)/2<0){var y=this._dom.resizer.style.bottom.slice(0,-2);return this._dom.resizer.style.bottom=0,this._dom.resizer.style.top=this._dom.resizer.style.top.slice(0,-2)-y/2,void(this._dom.resizer.style.right=this._dom.resizer.style.right.slice(0,-2)-y/2)}this._dom.resizer.style.right=this.containerRect.width-o+o-t,this._dom.resizer.style.bottom=this.containerRect.height-a+(o-t)/2,this._dom.resizer.style.top=i+(o-t)/2}else if(this._grab.b){if(n+(a-r)/2<0){var f=this._dom.resizer.style.left.slice(0,-2);return this._dom.resizer.style.left=0,this._dom.resizer.style.right=this._dom.resizer.style.right.slice(0,-2)-f/2,void(this._dom.resizer.style.bottom=this._dom.resizer.style.bottom.slice(0,-2)-f/2)}if(this.containerRect.width-o+(a-r)/2<0){var _=this._dom.resizer.style.right.slice(0,-2);return this._dom.resizer.style.right=0,this._dom.resizer.style.bottom=this._dom.resizer.style.bottom.slice(0,-2)-_/2,void(this._dom.resizer.style.left=this._dom.resizer.style.left.slice(0,-2)-_/2)}this._dom.resizer.style.bottom=this.containerRect.height-a+a-r,this._dom.resizer.style.left=n+(a-r)/2,this._dom.resizer.style.right=this.containerRect.width-o+(a-r)/2}}}},{key:"_mouseUp",value:function(e){e.preventDefault(),this._grab.tl=!1,this._grab.tr=!1,this._grab.br=!1,this._grab.bl=!1,this._grab.l=!1,this._grab.t=!1,this._grab.r=!1,this._grab.b=!1,this._computMinMax()}},{key:"_computMinMax",value:function(){this._min={x:this.resizerRect.x-this.containerRect.x,y:this.resizerRect.y-this.containerRect.y},this._max={x:this.resizerRect.x+this.resizerRect.width-this.containerRect.x,y:this.resizerRect.y+this.resizerRect.height-this.containerRect.y}}},{key:"_isGrabbed",value:function(){return!!(this._grab.tl||this._grab.tr||this._grab.bl||this._grab.br)||!!(this._grab.l||this._grab.t||this._grab.r||this._grab.b)}},{key:"getMinPoint",value:function(){return this._min}},{key:"getMaxPoint",value:function(){return this._max}}])&&_(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function b(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var k=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._target=t.target,this._onDropCB=t.onDrop,this._evtIds=[],this._movementCounter=0,this._transparentBorder="",this._buildElements(),this._events()}var t,r;return t=e,(r=[{key:"destroy",value:function(){}},{key:"_buildElements",value:function(){this._transparentBorder="dashed 3px transparent",this._target.style.border=this._transparentBorder}},{key:"_events",value:function(){this._target.addEventListener("dragenter",this._dragEnter.bind(this)),this._target.addEventListener("dragover",this._dragOver.bind(this)),this._target.addEventListener("dragleave",this._dragLeave.bind(this)),this._target.addEventListener("drop",this._drop.bind(this))}},{key:"_dragEnter",value:function(e){this._eventBehavior(e),++this._movementCounter,this._target.style.border="dashed 3px rgb(255, 100, 100)"}},{key:"_dragOver",value:function(e){this._eventBehavior(e),e.dataTransfer.dropEffect="copy"}},{key:"_dragLeave",value:function(e){this._eventBehavior(e),--this._movementCounter,0===this._movementCounter&&(this._target.style.border=this._transparentBorder)}},{key:"_drop",value:function(e){this._eventBehavior(e),this._target.style.border=this._transparentBorder,this._onDropCB(e.dataTransfer)}},{key:"_eventBehavior",value:function(e){e.preventDefault(),e.stopPropagation()}},{key:"_isTouchEventInTarget",value:function(e){var t=this._target.getBoundingClientRect(),r=e.pageX>=t.x&&e.pageX<=t.x+t.width,n=e.pageY>=t.y&&e.pageY<=t.y+t.height;return r&&n}}])&&b(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),w=Object.freeze({spot:new window.L.MarkerClusterGroup({animateAddingMarkers:!0,disableClusteringAtZoom:18,spiderfyOnMaxZoom:!1,iconCreateFunction:function(e){return window.L.divIcon({className:"cluster-icon-wrapper",html:'\n          <img src="/static/img/marker/cluster-icon-green.png" class="cluster-icon">\n          <span class="cluster-label">'.concat(e.getChildCount(),"</span>\n        ")})}}),shop:new window.L.MarkerClusterGroup({animateAddingMarkers:!0,disableClusteringAtZoom:18,spiderfyOnMaxZoom:!1,iconCreateFunction:function(e){return window.L.divIcon({className:"cluster-icon-wrapper",html:'\n          <img src="/static/img/marker/cluster-icon-blue.png" class="cluster-icon">\n          <span class="cluster-label">'.concat(e.getChildCount(),"</span>\n        ")})}}),bar:new window.L.MarkerClusterGroup({animateAddingMarkers:!0,disableClusteringAtZoom:18,spiderfyOnMaxZoom:!1,iconCreateFunction:function(e){return window.L.divIcon({className:"cluster-icon-wrapper",html:'\n          <img src="/static/img/marker/cluster-icon-red.png" class="cluster-icon">\n          <span class="cluster-label">'.concat(e.getChildCount(),"</span>\n        ")})}})}),L=Object.freeze({planOsm:window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',maxZoom:21,maxNativeZoom:19,minZoom:2}),satEsri:window.L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:'&copy; <a href="https://www.arcgis.com/home/item.html?id=10df2279f9684e4a9f6a7f08febac2a9">Esri Imagery</a>',minZoom:2,maxNativeZoom:19,maxZoom:21})});function E(e){return E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},E(e)}function S(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function M(e,t){return M=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},M(e,t)}function C(e,t){if(t&&("object"===E(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return P(e)}function P(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function I(e){return I=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},I(e)}var z=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&M(e,t)}(l,e);var t,r,n,o,s=(n=l,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=I(n);if(o){var r=I(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return C(this,e)});function l(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),(e=s.call(this))._map=null,e._zoomSlider=null,e._notification=null,e._user={lat:48.853121540141096,lng:2.3498955769881156,accuracy:0,marker:null,circle:null,range:null,color:a.USER_COLOR,id:-1,username:""},e._marks={spot:[],shop:[],bar:[]},e._clusters={spot:{},shop:{},bar:{}},e._newMarker=null,e._debugElement=null,e._watchId=null,e._isZooming=!1,e._kom=new i,e._lang=new c(window.navigator.language.substring(0,2),e._init.bind(P(e))),e}return t=l,(r=[{key:"_init",value:function(){this._debugElement=a.initDebugInterface(),this._notification=new f,this._initUser().then(this._initPreferences.bind(this)).then(this._initGeolocation.bind(this)).then(this._initMap.bind(this)).then(this._initEvents.bind(this)).then(this._initMarkers.bind(this))}},{key:"_initUser",value:function(){var e=this;return new Promise((function(t,r){e._kom.get("/api/user/me/").then((function(r){e._user.id=r.id,e._user.username=r.username,t()})).catch(r)}))}},{key:"_initPreferences",value:function(){var e=this;return new Promise((function(t){null===a.getPreference("poi-show-spot")&&a.setPreference("poi-show-spot",!0),null===a.getPreference("poi-show-shop")&&a.setPreference("poi-show-shop",!0),null===a.getPreference("poi-show-bar")&&a.setPreference("poi-show-bar",!0),null===a.getPreference("map-plan-layer")&&a.setPreference("map-plan-layer",!0),!0!==window.DEBUG&&"true"!==a.getPreference("app-debug")||(window.DEBUG=!0,a.setPreference("app-debug",!0),e.addDebugUI()),"true"===a.getPreference("map-center-on-user")&&document.getElementById("center-on").classList.add("lock-center-on"),t()}))}},{key:"_initGeolocation",value:function(){var e=this;return new Promise((function(t){if("geolocation"in navigator){var r="true"===a.getPreference("map-high-accuracy")?a.HIGH_ACCURACY:a.OPTIMIZED_ACCURACY;e._watchId=navigator.geolocation.watchPosition((function(r){e._user.lat=r.coords.latitude,e._user.lng=r.coords.longitude,e._user.accuracy=r.coords.accuracy,e._map&&(e.drawUserMarker(),e.updateMarkerCirclesVisibility(),"true"!==a.getPreference("map-center-on-user")||e._isZooming||e._map.setView(e._user),e.updateDebugUI()),t()}),t,r)}else e._notification.raise(e.nls.notif("geolocationError")),t()}))}},{key:"_initMap",value:function(){var e=this;return new Promise((function(t){e._map=window.L.map("beer-crakerz-map",{zoomControl:!1}).setView([e._user.lat,e._user.lng],18),window.L.control.scale().addTo(e._map),e.drawUserMarker();var r=L.planOsm,n=L.satEsri;e._map.setMaxBounds(a.MAP_BOUNDS);var i={};if(i["<p>".concat(e.nls.map("planLayerOSM"),"</p>")]=r,i["<p>".concat(e.nls.map("satLayerEsri"),"</p>")]=n,a.getPreference("map-plan-layer"))switch(a.getPreference("map-plan-layer")){case e.nls.map("planLayerOSM"):r.addTo(e._map);break;case e.nls.map("satLayerEsri"):n.addTo(e._map);break;default:r.addTo(e._map)}else r.addTo(e._map);window.L.control.layers(i,{},{position:"bottomright"}).addTo(e._map),e._zoomSlider=new g(e._map),t()}))}},{key:"_initEvents",value:function(){var e=this;return new Promise((function(t){document.getElementById("user-profile").addEventListener("click",e.userProfileModal.bind(e)),document.getElementById("hide-show").addEventListener("click",e.hidShowModal.bind(e)),document.getElementById("center-on").addEventListener("click",e.toggleFocusLock.bind(e)),document.getElementById("overlay").addEventListener("click",e.closeModal.bind(e)),e._map.on("click",e.mapClicked.bind(e)),e._map.on("drag",(function(){e._map.panInsideBounds(a.MAP_BOUNDS,{animate:!0}),"true"===a.getPreference("map-center-on-user")&&e.toggleFocusLock()})),e._map.on("zoomstart",(function(){e._isZooming=!0,"true"===a.getPreference("poi-show-circle")&&(e.setMarkerCircles(e._marks.spot,!1),e.setMarkerCircles(e._marks.shop,!1),e.setMarkerCircles(e._marks.bar,!1),e.setMarkerCircles([e._user],!1),e.setMarkerCircles([{circle:e._user.range}],!1))})),e._map.on("zoomend",(function(){e._isZooming=!1,"true"===a.getPreference("poi-show-circle")&&e._map.getZoom()>=15&&(e.setMarkerCircles(e._marks.spot,!0),e.setMarkerCircles(e._marks.shop,!0),e.setMarkerCircles(e._marks.bar,!0),e.setMarkerCircles([e._user],!0),e.setMarkerCircles([{circle:e._user.range}],!0)),"true"===a.getPreference("poi-marker-label")&&(e._map.getZoom()<15?(e.setMarkerLabels(e._marks.spot,!1),e.setMarkerLabels(e._marks.shop,!1),e.setMarkerLabels(e._marks.bar,!1)):(e.setMarkerLabels(e._marks.spot,!0),e.setMarkerLabels(e._marks.shop,!0),e.setMarkerLabels(e._marks.bar,!0))),e.updateDebugUI()})),e._map.on("baselayerchange",(function(e){a.setPreference("map-plan-layer",a.stripDom(e.name))})),t()}))}},{key:"_initMarkers",value:function(){var e=this;return new Promise((function(t){e._clusters.spot=w.spot,e._clusters.shop=w.shop,e._clusters.bar=w.bar,"true"===a.getPreference("poi-show-spot")&&e._map.addLayer(e._clusters.spot),"true"===a.getPreference("poi-show-shop")&&e._map.addLayer(e._clusters.shop),"true"===a.getPreference("poi-show-bar")&&e._map.addLayer(e._clusters.bar);var r=function(t){e.markPopupFactory(t).then((function(r){t.dom=r,t.marker=e.placeMarker(t),e._marks[t.type].push(t),e._clusters[t.type].addLayer(t.marker)}))};e._kom.getSpots().then((function(e){for(var t=0;t<e.length;++t)r(e[t])})),e._kom.getShops().then((function(e){for(var t=0;t<e.length;++t)r(e[t])})),e._kom.getBars().then((function(e){for(var t=0;t<e.length;++t)r(e[t])})),t()}))}},{key:"toggleFocusLock",value:function(){"true"===a.getPreference("map-center-on-user")?(this._notification.raise(this.nls.notif("unlockFocusOn")),document.getElementById("center-on").classList.remove("lock-center-on"),a.setPreference("map-center-on-user","false")):(this._notification.raise(this.nls.notif("lockFocusOn")),document.getElementById("center-on").classList.add("lock-center-on"),this._map.flyTo([this._user.lat,this._user.lng],18),a.setPreference("map-center-on-user","true"))}},{key:"toggleLabel",value:function(){var e=!("true"===a.getPreference("poi-marker-label"));this.setMarkerLabels(this._marks.spot,e),this.setMarkerLabels(this._marks.shop,e),this.setMarkerLabels(this._marks.bar,e),a.setPreference("poi-marker-label",e)}},{key:"toggleCircle",value:function(){var e=!("true"===a.getPreference("poi-show-circle"));this.setMarkerCircles(this._marks.spot,e),this.setMarkerCircles(this._marks.shop,e),this.setMarkerCircles(this._marks.bar,e),this.setMarkerCircles([this._user],e),this.setMarkerCircles([{circle:this._user.range}],e),a.setPreference("poi-show-circle",e)}},{key:"toggleMarkers",value:function(e){var t=!("true"===a.getPreference("poi-show-".concat(e)));!0===t?this._map.addLayer(this._clusters[e]):this._map.removeLayer(this._clusters[e]),a.setPreference("poi-show-".concat(e),t)}},{key:"toggleHighAccuracy",value:function(){var e=!("true"===a.getPreference("map-high-accuracy"));a.setPreference("map-high-accuracy",e),navigator.geolocation.clearWatch(this._watchId),this._initGeolocation().then(this.updateDebugUI.bind(this))}},{key:"toggleDebug",value:function(){var e=!window.DEBUG;window.DEBUG=e,a.setPreference("app-debug",e),e?this.addDebugUI():this.removeDebugUI()}},{key:"newMarkModal",value:function(e){document.getElementById("overlay").appendChild(e),document.getElementById("overlay").style.display="flex",setTimeout((function(){return document.getElementById("overlay").style.opacity=1}),50)}},{key:"editMarkModal",value:function(e){var t=this;this._kom.getTemplate("/modal/edit".concat(e.type)).then((function(r){var n=r.querySelector("#".concat(e.type,"-name")),i=r.querySelector("#".concat(e.type,"-desc")),o=r.querySelector("#".concat(e.type,"-submit")),s=r.querySelector("#".concat(e.type,"-cancel")),c=r.querySelector("#".concat(e.type,"-rating")),l=new d(c,e.rate);a.replaceString(r.querySelector("#nls-modal-title"),"{MODAL_TITLE}",t.nls.modal("".concat(e.type,"EditTitle"))),a.replaceString(r.querySelector("#nls-".concat(e.type,"-name")),"{".concat(e.type.toUpperCase(),"_NAME}"),t.nls[e.type]("nameLabel")),a.replaceString(r.querySelector("#nls-".concat(e.type,"-desc")),"{".concat(e.type.toUpperCase(),"_DESC}"),t.nls[e.type]("descLabel")),a.replaceString(r.querySelector("#nls-".concat(e.type,"-rate")),"{".concat(e.type.toUpperCase(),"_RATE}"),t.nls[e.type]("rateLabel")),a.replaceString(o,"{".concat(e.type.toUpperCase(),"_SUBMIT}"),t.nls.nav("edit")),a.replaceString(s,"{".concat(e.type.toUpperCase(),"_CANCEL}"),t.nls.nav("cancel")),n.value=e.name,i.value=e.description,o.addEventListener("click",(function(){for(var r=0;r<t._marks[e.type].length;++r)if(e.lat===t._marks[e.type][r].lat&&e.lng===t._marks[e.type][r].lng){t._marks[e.type][r].name=n.value,t._marks[e.type][r].description=i.value,t._marks[e.type][r].rate=l.currentRate,e.tooltip.removeFrom(t.map),t.markPopupFactory(e).then((function(r){e.dom=r,e.marker.setPopupContent(e.dom),t._kom["".concat(e.type,"Edited")](e.id,t.formatMarker(e)).then((function(){t._notification.raise(t.nls.notif("".concat(e.type,"Edited"))),t.closeModal(null,!0)}))}));break}})),s.addEventListener("click",t.closeModal.bind(t,null,!0)),document.getElementById("overlay").appendChild(r),document.getElementById("overlay").style.display="flex",setTimeout((function(){return document.getElementById("overlay").style.opacity=1}),50)}))}},{key:"deleteMarkModal",value:function(e){var t=this;this._kom.getTemplate("/modal/deletemark").then((function(r){a.replaceString(r.querySelector("#nls-modal-title"),"{MODAL_TITLE}",t.nls.modal("deleteMarkTitle")),a.replaceString(r.querySelector("#nls-modal-desc"),"{MODAL_DESC}",t.nls.modal("deleteMarkDesc")),a.replaceString(r.querySelector("#cancel-close"),"{MODAL_CANCEL}",t.nls.nav("cancel")),a.replaceString(r.querySelector("#delete-close"),"{MODAL_DELETE}",t.nls.nav("delete")),document.getElementById("overlay").appendChild(r),document.getElementById("overlay").style.display="flex",document.getElementById("cancel-close").addEventListener("click",(function(r){t.closeModal(r),e(!1)}),!1),document.getElementById("delete-close").addEventListener("click",(function(r){t.closeModal(r),e(!0)}),!1),setTimeout((function(){return document.getElementById("overlay").style.opacity=1}),50)}))}},{key:"userProfileModal",value:function(){var e=this;this._kom.getTemplate("/modal/user").then((function(t){a.replaceString(t.querySelector("#nls-modal-title"),"{MODAL_TITLE}",e.nls.modal("userTitle")),a.replaceString(t.querySelector("#nls-user-modal-accuracy"),"{ACCURACY_USER_MODAL}",e.nls.modal("userAccuracyPref")),a.replaceString(t.querySelector("#nls-user-modal-debug"),"{DEBUG_USER_MODAL}",e.nls.modal("userDebugPref")),a.replaceString(t.querySelector("#nls-about-desc"),"{BEERCRACKERZ_DESC}",e.nls.modal("aboutDesc")),a.replaceString(t.querySelector("#nls-update-pp"),"{UPDATE_PROFILE_PIC_LABEL}",e.nls.modal("updatePP")),new k({target:t.querySelector("#update-pp-wrapper"),onDrop:e.updateProfilePictureModal.bind(e)}),document.getElementById("overlay").appendChild(t),document.getElementById("overlay").style.display="flex","true"===a.getPreference("map-high-accuracy")&&(document.getElementById("high-accuracy-toggle").checked=!0),!0!==window.DEBUG&&"true"!==a.getPreference("app-debug")||(document.getElementById("debug-toggle").checked=!0),document.getElementById("high-accuracy-toggle").addEventListener("change",e.toggleHighAccuracy.bind(e)),document.getElementById("debug-toggle").addEventListener("change",e.toggleDebug.bind(e)),document.getElementById("update-pp").addEventListener("change",e.updateProfilePictureModal.bind(e)),setTimeout((function(){return document.getElementById("overlay").style.opacity=1}),50),document.getElementById("logout").addEventListener("click",(function(){e._kom.post("api/auth/logout/",null).then((function(){window.location="/welcome"}))}))}))}},{key:"updateProfilePictureModal",value:function(e){var t=this,r={files:document.getElementById("update-pp").files};if(e.files&&1===e.files.length&&(r={files:e.files}),r.files&&1===r.files.length){if(r.files[0].size>2621440)return document.getElementById("update-pp").value="",document.getElementById("update-pp").classList.add("error"),void(document.getElementById("update-pp-error").innerHTML=this.nls.modal("updatePPSizeError"));this._kom.getTemplate("/modal/updatepp").then((function(e){if(a.replaceString(e.querySelector("#nls-modal-title"),"{MODAL_TITLE}",t.nls.modal("updatePPTitle")),a.replaceString(e.querySelector("#nls-modal-desc"),"{UPDATE_PP_DESC}",t.nls.modal("updatePPDesc")),a.replaceString(e.querySelector("#update-pp-cancel"),"{UPDATE_PP_CANCEL}",t.nls.nav("cancel")),a.replaceString(e.querySelector("#update-pp-submit"),"{UPDATE_PP_SUBMIT}",t.nls.nav("upload")),document.getElementById("overlay").appendChild(e),document.getElementById("overlay").style.display="flex",FileReader){var n=new FileReader;n.onload=function(){var e;document.getElementById("wip-pp").src=n.result,e=new v({wrapper:document.getElementById("wip-pp-wrapper")}),document.getElementById("update-pp-submit").addEventListener("click",(function(){t._kom.patchImage("api/user/".concat(t._user.id,"/profile-picture/"),{profile_picture:document.getElementById("wip-pp").src,minX:e.getMinPoint().x,minY:e.getMinPoint().y,maxX:e.getMaxPoint().x,maxY:e.getMaxPoint().y}).then((function(){console.log("done")})).catch((function(){console.log("Failed")}))})),document.getElementById("update-pp-cancel").addEventListener("click",t.closeModal.bind(t,null,!0))},n.readAsDataURL(r.files[0])}else console.error("Couldnt read file")}))}}},{key:"hidShowModal",value:function(){var e=this;this._kom.getTemplate("/modal/hideshow").then((function(t){a.replaceString(t.querySelector("#nls-hideshow-modal-title"),"{MODAL_TITLE}",e.nls.modal("hideShowTitle")),a.replaceString(t.querySelector("#nls-hideshow-modal-labels"),"{LABELS_HIDESHOW_MODAL}",e.nls.modal("hideShowLabels")),a.replaceString(t.querySelector("#nls-hideshow-modal-circles"),"{CIRCLES_HIDESHOW_MODAL}",e.nls.modal("hideShowCircles")),a.replaceString(t.querySelector("#nls-hideshow-modal-spots"),"{SPOTS_HIDESHOW_MODAL}",e.nls.modal("hideShowSpots")),a.replaceString(t.querySelector("#nls-hideshow-modal-shops"),"{SHOPS_HIDESHOW_MODAL}",e.nls.modal("hideShowShops")),a.replaceString(t.querySelector("#nls-hideshow-modal-bars"),"{BARS_HIDESHOW_MODAL}",e.nls.modal("hideShowBars")),a.replaceString(t.querySelector("#modal-close-button"),"{MODAL_CLOSE}",e.nls.nav("close")),document.getElementById("overlay").appendChild(t),document.getElementById("overlay").style.display="flex","true"===a.getPreference("poi-marker-label")&&(document.getElementById("label-toggle").checked=!0),"true"===a.getPreference("poi-show-circle")&&(document.getElementById("circle-toggle").checked=!0),"true"===a.getPreference("poi-show-spot")&&(document.getElementById("show-spots").checked=!0),"true"===a.getPreference("poi-show-shop")&&(document.getElementById("show-shops").checked=!0),"true"===a.getPreference("poi-show-bar")&&(document.getElementById("show-bars").checked=!0),document.getElementById("label-toggle").addEventListener("change",e.toggleLabel.bind(e)),document.getElementById("circle-toggle").addEventListener("change",e.toggleCircle.bind(e)),document.getElementById("show-spots").addEventListener("change",e.toggleMarkers.bind(e,"spot")),document.getElementById("show-shops").addEventListener("change",e.toggleMarkers.bind(e,"shop")),document.getElementById("show-bars").addEventListener("change",e.toggleMarkers.bind(e,"bar")),setTimeout((function(){return document.getElementById("overlay").style.opacity=1}),50)}))}},{key:"closeModal",value:function(e,t){!0!==t&&"overlay"!==e.target.id&&-1===e.target.id.indexOf("close")||(document.getElementById("overlay").style.opacity=0,setTimeout((function(){document.getElementById("overlay").style.display="none",document.getElementById("overlay").innerHTML=""}),300))}},{key:"mapClicked",value:function(e){this._newMarker&&this._newMarker.popupClosed?this._newMarker=null:null!==this._newMarker&&this._newMarker.isBeingDefined||(a.getDistanceBetweenCoords([this._user.lat,this._user.lng],[e.latlng.lat,e.latlng.lng])<a.NEW_MARKER_RANGE?this._newMarker=this.definePOI(e.latlng,this._markerSaved.bind(this)):this._notification.raise(this.nls.notif("newMarkerOutside")))}},{key:"_markerSaved",value:function(e){var t=this;this._kom["".concat(e.type,"Created")](this.formatMarker(e)).then((function(){t._marks[e.type].push(e),t._clusters[e.type].addLayer(e.marker),t._notification.raise(t.nls.notif("".concat(e.type,"Added"))),t.updateMarkerCirclesVisibility(),t._newMarker=null}))}},{key:"updateMarkerCirclesVisibility",value:function(){var e=this,t=function(t){for(var r=0;r<t.length;++r)if(e._map.getBounds().contains(t[r].marker.getLatLng())){var n=t[r].marker,i=a.getDistanceBetweenCoords([e._user.lat,e._user.lng],[n.getLatLng().lat,n.getLatLng().lng]);i<a.CIRCLE_RADIUS&&!t[r].circle.visible?(t[r].circle.visible=!0,t[r].circle.setStyle({opacity:1,fillOpacity:.1})):i>=a.CIRCLE_RADIUS&&t[r].circle.visible&&(t[r].circle.visible=!1,t[r].circle.setStyle({opacity:0,fillOpacity:0}))}};"true"===a.getPreference("poi-show-circle")&&(t(this._marks.spot),t(this._marks.shop),t(this._marks.bar),t([this._user]))}},{key:"formatMarker",value:function(e){return{name:e.name,description:e.description,lat:e.lat,lng:e.lng,rate:e.rate}}},{key:"editMarker",value:function(e){this._map.closePopup(),this.editMarkModal(e)}},{key:"deleteMarker",value:function(e){var t=this;this.deleteMarkModal((function(r){!0===r&&function(){for(var r=t._marks[e.type],n=function(n){if(e.lat===r[n].lat&&e.lng===r[n].lng)return t._kom["".concat(e.type,"Deleted")](r[n].id,t.formatMarker(r[n])).then((function(){t.setMarkerCircles([r[n]],!1),t.setMarkerLabels([r[n]],!1),t._clusters[e.type].removeLayer(r[n].marker),r.splice(n,1),t._marks[e.type]=r,t._notification.raise(t.nls.notif("".concat(e.type,"Deleted")))})),"break"},i=0;i<r.length&&"break"!==n(i);++i);}()}))}},{key:"addDebugUI",value:function(){document.body.appendChild(this._debugElement)}},{key:"removeDebugUI",value:function(){document.body.removeChild(this._debugElement)}},{key:"updateDebugUI",value:function(){var e="true"===a.getPreference("map-high-accuracy")?a.HIGH_ACCURACY:a.OPTIMIZED_ACCURACY;a.updateDebugInterface(this._debugElement,this._user,e)}},{key:"downloadData",value:function(){var e="data:text/json;charset=utf-8,".concat(encodeURIComponent(a.getPreference("saved-spot"))),t=document.createElement("A");t.setAttribute("href",e),t.setAttribute("download","BeerCrackerzData.json"),t.click()}},{key:"map",get:function(){return this._map}},{key:"marks",get:function(){return this._marks}},{key:"user",get:function(){return this._user}},{key:"kom",get:function(){return this._kom}},{key:"nls",get:function(){return this._lang}}])&&S(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),l}(p);window.BeerCrackerz=t.default}();