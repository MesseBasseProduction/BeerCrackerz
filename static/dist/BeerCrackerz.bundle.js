!function(){"use strict";var e={d:function(t,r){for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}},t={};e.d(t,{default:function(){return w}});var r=Object.freeze({blue:new window.L.Icon({iconUrl:"/assets/img/marker/marker-icon-blue.png",shadowUrl:"/assets/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),gold:new window.L.Icon({iconUrl:"/assets/img/marker/marker-icon-gold.png",shadowUrl:"/assets/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),red:new window.L.Icon({iconUrl:"/assets/img/marker/marker-icon-red.png",shadowUrl:"/assets/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),green:new window.L.Icon({iconUrl:"/assets/img/marker/marker-icon-green.png",shadowUrl:"/assets/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),orange:new window.L.Icon({iconUrl:"/assets/img/marker/marker-icon-orange.png",shadowUrl:"/assets/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),yellow:new window.L.Icon({iconUrl:"/assets/img/marker/marker-icon-yellow.png",shadowUrl:"/assets/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),violet:new window.L.Icon({iconUrl:"/assets/img/marker/marker-icon-violet.png",shadowUrl:"/assets/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),grey:new window.L.Icon({iconUrl:"/assets/img/marker/marker-icon-grey.png",shadowUrl:"/assets/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),black:new window.L.Icon({iconUrl:"/assets/img/marker/marker-icon-black.png",shadowUrl:"/assets/img/marker/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),user:new window.L.Icon({iconUrl:"/assets/img/marker/user-position.png",shadowUrl:"/assets/img/marker/user-position-shadow.png",iconSize:[32,32],iconAnchor:[16,16],popupAnchor:[1,-34],shadowSize:[32,32]})});function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var a=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._container=null,this._items=[],this._currentRate=r||0,this._clicked=r||-1,this._init(t),this._events()}var t,r;return t=e,(r=[{key:"_init",value:function(e){this._container=e;for(var t=0;t<e.children.length;++t)this._items.push(e.children[t]);for(var r=0;r<this._currentRate+1;++r)this._items[r].classList.add("active"),this._items[r].classList.add("selected")}},{key:"_events",value:function(){this._container.addEventListener("mouseover",this._containerHovered.bind(this),!1),this._container.addEventListener("mouseout",this._pointerExit.bind(this),!1);for(var e=0;e<this._items.length;++e)this._items[e].addEventListener("click",this._starClicked.bind(this),!1)}},{key:"_containerHovered",value:function(e){"IMG"===e.target.tagName&&(this._currentRate=parseInt(e.target.dataset.id),this._container.dataset.rate=this._currentRate,this.updateStars())}},{key:"_pointerExit",value:function(){this._currentRate=-1===this._clicked?0:this._clicked,this._container.dataset.rate=this._currentRate,this.updateStars()}},{key:"_starClicked",value:function(e){this._currentRate=parseInt(e.target.dataset.id),this._container.dataset.rate=this._currentRate,this._clicked=this._currentRate,this.updateStars()}},{key:"updateStars",value:function(){for(var e=0;e<this._items.length;++e)e<=this._currentRate?(this._items[e].classList.add("active"),e<=this._clicked&&this._items[e].classList.add("selected")):(this._items[e].classList.remove("active"),this._items[e].classList.remove("selected"))}},{key:"currentRate",get:function(){return this._currentRate}}])&&n(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function o(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r;return t=e,r=[{key:"fetchTemplate",value:function(e){return new Promise((function(t,r){fetch(e).then((function(e){e.text().then((function(e){t(document.createRange().createContextualFragment(e))})).catch(r)})).catch(r)}))}},{key:"fetchFile",value:function(e){return new Promise((function(t,r){fetch(e).then((function(e){e.text().then(t).catch(r)})).catch(r)}))}},{key:"getReq",value:function(e){return new Promise((function(t,r){var n={method:"GET",headers:new Headers,mode:"cors",cache:"default",url:"http://localhost:8080"};fetch(e,n).then((function(e){e.json().then(t).catch(r)})).catch(r)}))}},{key:"postReq",value:function(e,t){return new Promise((function(r,n){var a={method:"POST",headers:new Headers,mode:"cors",cache:"default",body:t};fetch(e,a).then((function(e){e.json().then(r).catch(n)})).catch(n)}))}},{key:"stripDom",value:function(e){return(new DOMParser).parseFromString(e,"text/html").body.textContent||""}},{key:"replaceString",value:function(e,t,r){e.innerHTML=e.innerHTML.replace(t,r)}},{key:"getDistanceBetweenCoords",value:function(e,t){var r=e[1]*Math.PI/180,n=e[0]*Math.PI/180,a=t[1]*Math.PI/180,o=t[0]*Math.PI/180,i=o-n,c=a-r,s=Math.pow(Math.sin(i/2),2)+Math.cos(n)*Math.cos(o)*Math.pow(Math.sin(c/2),2);return 2*Math.asin(Math.sqrt(s))*6371*1e3}},{key:"precisionRound",value:function(e,t){var r=Math.pow(10,t||0);return Math.round(e*r)/r}},{key:"initDebugInterface",value:function(){var e=window.BeerCrackerz.nls.debug.bind(window.BeerCrackerz.nls),t=document.createElement("DIV"),r=document.createElement("P"),n=document.createElement("P"),a=document.createElement("P"),o=document.createElement("P"),i=document.createElement("P"),c=document.createElement("P"),s=document.createElement("P"),l=document.createElement("P"),u=document.createElement("P"),d=document.createElement("BUTTON");return t.classList.add("debug-container"),r.classList.add("debug-user-lat"),n.classList.add("debug-user-lng"),a.classList.add("debug-updates-amount"),o.classList.add("debug-user-accuracy"),i.classList.add("debug-high-accuracy"),c.classList.add("debug-pos-max-age"),s.classList.add("debug-pos-timeout"),l.classList.add("debug-zoom-level"),u.classList.add("debug-marks-amount"),d.classList.add("debug-export-data"),r.innerHTML="<b>".concat(e("lat"),"</b> : -"),n.innerHTML="<b>".concat(e("lng"),"</b> : -"),a.innerHTML="<b>".concat(e("updates"),"</b> : 0"),o.innerHTML="<b>".concat(e("accuracy"),"</b> : -"),i.innerHTML="<b>".concat(e("highAccuracy"),"</b> : -"),c.innerHTML="<b>".concat(e("posAge"),"</b> : -"),s.innerHTML="<b>".concat(e("posTimeout"),"</b> : -"),l.innerHTML="<b>".concat(e("zoom"),"</b> : -"),u.innerHTML="<b>".concat(e("marks"),"</b> : -"),d.innerHTML=e("export"),t.appendChild(r),t.appendChild(n),t.appendChild(a),t.appendChild(o),t.appendChild(i),t.appendChild(c),t.appendChild(s),t.appendChild(l),t.appendChild(u),t.appendChild(d),d.addEventListener("click",window.BeerCrackerz.downloadData.bind(window.BeerCrackerz)),t}},{key:"updateDebugInterface",value:function(t,r,n){if(!0===window.DEBUG){var a=window.BeerCrackerz,o=a.nls.debug.bind(a.nls),i=parseInt(t.querySelector(".debug-updates-amount").innerHTML.split(" : ")[1])+1,c=a.marks.spot.length+a.marks.store.length+a.marks.bar.length;t.querySelector(".debug-user-lat").innerHTML="\n        <b>".concat(o("lat"),"</b> : ").concat(r.lat,"\n      "),t.querySelector(".debug-user-lng").innerHTML="\n        <b>".concat(o("lng"),"</b> : ").concat(r.lng,"\n      "),t.querySelector(".debug-updates-amount").innerHTML="\n        <b>".concat(o("updates"),"</b> : ").concat(i,"\n      "),t.querySelector(".debug-user-accuracy").innerHTML="\n        <b>".concat(o("accuracy"),"</b> : ").concat(e.precisionRound(r.accuracy,2),"m\n      "),t.querySelector(".debug-high-accuracy").innerHTML="\n        <b>".concat(o("highAccuracy"),"</b> : ").concat(!0===n.enableHighAccuracy?o("enabled"):o("disabled"),"\n      "),t.querySelector(".debug-pos-max-age").innerHTML="\n        <b>".concat(o("posAge"),"</b> : ").concat(n.maximumAge/1e3,"s\n      "),t.querySelector(".debug-pos-timeout").innerHTML="\n        <b>".concat(o("posTimeout"),"</b> : ").concat(n.timeout/1e3,"s\n      "),t.querySelector(".debug-zoom-level").innerHTML="\n        <b>".concat(o("zoom"),"</b> : ").concat(a.map.getZoom(),"\n      "),t.querySelector(".debug-marks-amount").innerHTML="\n        <b>".concat(o("marks"),"</b> : ").concat(c,"\n      ")}}},{key:"getPoints",value:function(t){return new Promise((function(r){e.getReq("http://localhost:8080/api/".concat(t)).then(r)}))}},{key:"getSpots",value:function(){return new Promise((function(t){e.getPoints("spot").then(t)}))}},{key:"getStores",value:function(){return new Promise((function(t){e.getPoints("shop").then(t)}))}},{key:"getBars",value:function(){return new Promise((function(t){e.getPoints("bar").then(t)}))}},{key:"getPreference",value:function(e){return localStorage.getItem(e)||null}},{key:"setPreference",value:function(e,t){localStorage.setItem(e,t)}},{key:"RANGE_COLOR",get:function(){return"#ffd87d"}},{key:"USER_COLOR",get:function(){return"#63fff5"}},{key:"SPOT_COLOR",get:function(){return"#26ad23"}},{key:"STORE_COLOR",get:function(){return"#247dc9"}},{key:"BAR_COLOR",get:function(){return"#ca2a3d"}},{key:"CIRCLE_RADIUS",get:function(){return 100}},{key:"NEW_MARKER_RANGE",get:function(){return 200}},{key:"MAP_BOUNDS",get:function(){return window.L.latLngBounds(window.L.latLng(-89.98155760646617,-180),window.L.latLng(89.99346179538875,180))}},{key:"HIGH_ACCURACY",get:function(){return{enableHighAccuracy:!0,maximumAge:1e3,timeout:900}}},{key:"OPTIMIZED_ACCURACY",get:function(){return{enableHighAccuracy:!1,maximumAge:3e4,timeout:29e3}}},{key:"SUPPORTED_LANGUAGE",get:function(){return["en","fr","es","de"]}}],null&&o(t.prototype,null),r&&o(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function c(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,(n=[{key:"placeMarker",value:function(e){var t=this,n=r.black;"store"===e.type?n=r.blue:"spot"===e.type?n=r.green:"bar"===e.type?n=r.red:"user"===e.type&&(n=r.user);var a=window.L.marker([e.lat,e.lng],{icon:n}).on("click",(function(){"true"===i.getPreference("map-center-on-user")&&t.toggleFocusLock(),t.map.flyTo([e.lat,e.lng],18)}));return e.dom&&a.bindPopup(e.dom),-1===["spot","store","bar"].indexOf(e.type)&&a.addTo(this.map),a}},{key:"drawUserMarker",value:function(){this.user.marker?(this.user.marker.setLatLng(this.user),this.user.range.setLatLng(this.user),this.user.circle.setLatLng(this.user),this.user.circle.setRadius(this.user.accuracy)):(this.user.type="user",this.user.marker=this.placeMarker(this.user),this.user.radius=this.user.accuracy,this.user.circle=this.drawCircle(this.user),this.user.range=this.drawCircle({lat:this.user.lat,lng:this.user.lng,radius:i.NEW_MARKER_RANGE,color:i.RANGE_COLOR}),"true"===i.getPreference("poi-show-circle")&&(this.user.circle.setStyle({opacity:1,fillOpacity:.1}),this.user.range.setStyle({opacity:1,fillOpacity:.1})),this.user.marker.on("click",this.mapClicked.bind(this)))}},{key:"definePOI",value:function(e,t){var r=this,n={wrapper:document.createElement("DIV"),title:document.createElement("P"),spot:document.createElement("BUTTON"),store:document.createElement("BUTTON"),bar:document.createElement("BUTTON")};n.wrapper.className="new-poi",n.title.innerHTML=this.nls.map("newTitle"),n.spot.innerHTML=this.nls.map("newSpot"),n.store.innerHTML=this.nls.map("newStore"),n.bar.innerHTML=this.nls.map("newBar"),n.spot.dataset.type="spot",n.store.dataset.type="store",n.bar.dataset.type="bar",n.wrapper.appendChild(n.title),n.wrapper.appendChild(n.spot),n.wrapper.appendChild(n.store),n.wrapper.appendChild(n.bar),e.dom=n.wrapper;var a=this.placeMarker(e).openPopup();e.marker=a,e.addedCallback=t;var o=function(t){a.isBeingDefined=!0,a.closePopup(),r.defineMarkFactory(t.target.dataset.type,e)};return n.spot.addEventListener("click",o),n.store.addEventListener("click",o),n.bar.addEventListener("click",o),a.on("popupclose",(function(){a.isBeingDefined||(a.popupClosed=!0,a.removeFrom(r.map))})),a}},{key:"defineMarkFactory",value:function(e,t){var r=this;i.fetchTemplate("/assets/html/modal/new".concat(e,".html")).then((function(n){var o=n.querySelector("#".concat(e,"-name")),c=n.querySelector("#".concat(e,"-desc")),s=new a(n.querySelector("#".concat(e,"-rating"))),l=n.querySelector("#".concat(e,"-submit")),u=n.querySelector("#".concat(e,"-cancel")),d=n.querySelector("#modal-close");i.replaceString(n.querySelector("#nls-".concat(e,"-title")),"{{".concat(e.toUpperCase(),"_TITLE}}"),r.nls[e]("title")),i.replaceString(n.querySelector("#nls-".concat(e,"-subtitle")),"{{".concat(e.toUpperCase(),"_SUBTITLE}}"),r.nls[e]("subtitle")),i.replaceString(n.querySelector("#nls-".concat(e,"-name")),"{{".concat(e.toUpperCase(),"_NAME}}"),r.nls[e]("nameLabel")),i.replaceString(n.querySelector("#nls-".concat(e,"-desc")),"{{".concat(e.toUpperCase(),"_DESC}}"),r.nls[e]("descLabel")),i.replaceString(n.querySelector("#nls-".concat(e,"-rate")),"{{".concat(e.toUpperCase(),"_RATE}}"),r.nls[e]("rateLabel")),i.replaceString(l,"{{".concat(e.toUpperCase(),"_SUBMIT}}"),r.nls.nav("add")),i.replaceString(u,"{{".concat(e.toUpperCase(),"_CANCEL}}"),r.nls.nav("cancel"));var p=function(){t.marker.isBeingDefined=!1,t.marker.removeFrom(r.map),r.closeModal(null,!0)};l.addEventListener("click",(function(){""===o.value?r._notification.raise(r.nls.notif("markNameEmpty")):(p(),t.type=e,t.name=o.value,t.description=c.value,t.rate=s.currentRate,r.markPopupFactory(t).then((function(e){t.dom=e,t.marker=r.placeMarker(t),t.addedCallback(t)})))})),u.addEventListener("click",p),d.addEventListener("click",p),r.newMarkModal(n)}))}},{key:"defineNewSpot",value:function(e){this.defineMarkFactory("spot",e)}},{key:"defineNewStore",value:function(e){this.defineMarkFactory("store",e)}},{key:"defineNewBar",value:function(e){this.defineMarkFactory("bar",e)}},{key:"markPopupFactory",value:function(e){var t=this;return new Promise((function(r){i.fetchTemplate("/assets/html/popup/".concat(e.type,".html")).then((function(n){var a=document.createElement("DIV");a.appendChild(n);var o=e.user||t.user.username,c=i.stripDom(e.description)||t.nls.popup("".concat(e.type,"NoDesc"));i.replaceString(a,"{{".concat(e.type.toUpperCase(),"_NAME}}"),i.stripDom(e.name)),i.replaceString(a,"{{".concat(e.type.toUpperCase(),"_FINDER}}"),o),i.replaceString(a,"{{".concat(e.type.toUpperCase(),"_RATE}}"),e.rate+1),i.replaceString(a,"{{".concat(e.type.toUpperCase(),"_DESC}}"),c),i.replaceString(a,"{{".concat(e.type.toUpperCase(),"_FOUND_BY}}"),t.nls.popup("".concat(e.type,"FoundBy")));for(var s=a.querySelector("#".concat(e.type,"-rating")),l=0;l<e.rate+1;++l)s.children[l].classList.add("active");i.getDistanceBetweenCoords([t.user.lat,t.user.lng],[e.lat,e.lng])>i.CIRCLE_RADIUS&&console.log("Too far"),o!==t.user.username?a.removeChild(a.querySelector("#popup-edit")):(a.querySelector("#edit-mark").addEventListener("click",t.editMarker.bind(t,e),!1),a.querySelector("#delete-mark").addEventListener("click",t.deleteMarker.bind(t,e),!1)),e.color=i["".concat(e.type.toUpperCase(),"_COLOR")],e.circle=t.drawCircle(e),e.tooltip=window.L.tooltip({permanent:!0,direction:"center",className:"marker-tooltip",interactive:!0}).setContent(e.name).setLatLng(e.circle.getLatLng()),"true"===i.getPreference("poi-marker-label")&&e.tooltip.addTo(t.map),r(a)}))}))}},{key:"drawCircle",value:function(e){return window.L.circle(e,{color:e.color,fillColor:e.color,opacity:0,fillOpacity:0,radius:e.radius?e.radius:i.CIRCLE_RADIUS}).addTo(this.map)}},{key:"setMarkerCircles",value:function(e,t){for(var r=0;r<e.length;++r)t?(e[r].circle.setStyle({opacity:1,fillOpacity:.1}),e[r].circle.addTo(this.map)):(e[r].circle.setStyle({opacity:0,fillOpacity:0}),e[r].circle.removeFrom(this.map))}},{key:"setMarkerLabels",value:function(e,t){for(var r=0;r<e.length;++r)t?e[r].tooltip.addTo(this.map):e[r].tooltip.removeFrom(this.map)}}])&&c(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),e}(),l=Object.freeze({planOsm:window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',maxZoom:21,maxNativeZoom:19,minZoom:2}),satEsri:window.L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:'&copy; <a href="https://www.arcgis.com/home/item.html?id=10df2279f9684e4a9f6a7f08febac2a9">Esri Imagery</a>',minZoom:2,maxNativeZoom:19,maxZoom:21})});function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var d=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._map=t,this._container=document.querySelector("#zoom-slider"),this._slider=document.querySelector("#slider-position"),this._zoomRange=this._map.getMaxZoom()-this._map.getMinZoom(),this._timeoutId=-1,this._events()}var t,r;return t=e,(r=[{key:"_events",value:function(){var e=this;this._map.on("zoomstart",(function(){clearTimeout(e._timeoutId),e._timeoutId=-1,e._container.classList.add("opened")})),this._map.on("zoomend",(function(){var t=e._map.getZoom()-e._map.getMinZoom();e._slider.style.height="".concat(100*t/e._zoomRange,"%"),e._timeoutId=setTimeout((function(){return e._container.classList.remove("opened")}),1500)})),this._map.on("zoom",(function(){clearTimeout(e._timeoutId),e._timeoutId=-1;var t=e._map.getZoom()-e._map.getMinZoom();e._slider.style.height="".concat(100*t/e._zoomRange,"%")})),this._container.addEventListener("mouseover",(function(){clearTimeout(e._timeoutId),e._timeoutId=-1})),this._container.addEventListener("mouseleave",(function(){e._timeoutId=setTimeout((function(){return e._container.classList.remove("opened")}),1500)})),this._container.querySelector("#zoom-more").addEventListener("click",(function(){e._map.setZoom(e._map.getZoom()+1)})),this._container.querySelector("#zoom-less").addEventListener("click",(function(){e._map.setZoom(e._map.getZoom()-1)}))}}])&&u(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function p(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var m=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._lang=-1!==i.SUPPORTED_LANGUAGE.indexOf(t)?t:"en",this._values={},this._init().then(r)}var t,r;return t=e,(r=[{key:"_init",value:function(){var e=this;return new Promise((function(t,r){i.fetchFile("/assets/nls/".concat(e._lang,".json")).then((function(r){e._values=JSON.parse(r),t()})).catch(r)}))}},{key:"debug",value:function(e){return this._values.debug[e]||""}},{key:"notif",value:function(e){return this._values.notif[e]||""}},{key:"nav",value:function(e){return this._values.nav[e]||""}},{key:"map",value:function(e){return this._values.map[e]||""}},{key:"spot",value:function(e){return this._values.spot[e]||""}},{key:"store",value:function(e){return this._values.store[e]||""}},{key:"bar",value:function(e){return this._values.bar[e]||""}},{key:"popup",value:function(e){return this._values.popup[e]||""}},{key:"modal",value:function(e){return this._values.modal[e]||""}},{key:"login",value:function(e){return this._values.auth.login[e]||""}},{key:"register",value:function(e){return this._values.auth.register[e]||""}},{key:"forgotPassword",value:function(e){return this._values.auth.forgotPassword[e]||""}}])&&p(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function h(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var g=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._container=document.querySelector("#notification-wrapper"),this._message=document.querySelector("#notification-message"),this._timeoutId=null}var t,r;return t=e,(r=[{key:"raise",value:function(e){var t=this;clearTimeout(this._timeoutId),this._message.innerHTML=e,this._container.classList.add("opened"),this._timeoutId=setTimeout((function(){t._container.classList.remove("opened"),t._message.innerHTML=""}),2e3)}}])&&h(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function y(e){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},y(e)}function f(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function k(e,t){return k=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},k(e,t)}function _(e,t){if(t&&("object"===y(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return v(e)}function v(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function b(e){return b=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},b(e)}var w=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&k(e,t)}(s,e);var t,r,n,o,c=(n=s,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=b(n);if(o){var r=b(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return _(this,e)});function s(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),(e=c.call(this))._map=null,e._zoomSlider=null,e._notification=null,e._user={lat:48.853121540141096,lng:2.3498955769881156,accuracy:0,marker:null,circle:null,range:null,color:i.USER_COLOR,id:-1,username:""},e._marks={spot:[],store:[],bar:[]},e._clusters={spot:{},store:{},bar:{}},e._newMarker=null,e._debugElement=null,e._watchId=null,e._isZooming=!1,e._lang=new m(window.navigator.language.substring(0,2),e._init.bind(v(e))),e}return t=s,(r=[{key:"_init",value:function(){this._debugElement=i.initDebugInterface(),this._notification=new g,this._initUser().then(this._initPreferences.bind(this)).then(this._initGeolocation.bind(this)).then(this._initMap.bind(this)).then(this._initEvents.bind(this)).then(this._initMarkers.bind(this))}},{key:"_initUser",value:function(){var e=this;return new Promise((function(t){e._user.id=42,e._user.username="messmaker",t()}))}},{key:"_initPreferences",value:function(){var e=this;return new Promise((function(t){null===i.getPreference("poi-show-spot")&&i.setPreference("poi-show-spot",!0),null===i.getPreference("poi-show-store")&&i.setPreference("poi-show-store",!0),null===i.getPreference("poi-show-bar")&&i.setPreference("poi-show-bar",!0),null===i.getPreference("map-plan-layer")&&i.setPreference("map-plan-layer",!0),!0!==window.DEBUG&&"true"!==i.getPreference("app-debug")||(window.DEBUG=!0,i.setPreference("app-debug",!0),e.addDebugUI()),"true"===i.getPreference("map-center-on-user")&&document.getElementById("center-on").classList.add("lock-center-on"),t()}))}},{key:"_initGeolocation",value:function(){var e=this;return new Promise((function(t){if("geolocation"in navigator){var r="true"===i.getPreference("map-high-accuracy")?i.HIGH_ACCURACY:i.OPTIMIZED_ACCURACY;e._watchId=navigator.geolocation.watchPosition((function(r){e._user.lat=r.coords.latitude,e._user.lng=r.coords.longitude,e._user.accuracy=r.coords.accuracy,e._map&&(e.drawUserMarker(),e.updateMarkerCirclesVisibility(),"true"!==i.getPreference("map-center-on-user")||e._isZooming||e._map.setView(e._user),e.updateDebugUI()),t()}),t,r)}else e._notification.raise(e.nls.notif("geolocationError")),t()}))}},{key:"_initMap",value:function(){var e=this;return new Promise((function(t){e._map=window.L.map("beer-crakerz-map",{zoomControl:!1}).setView([e._user.lat,e._user.lng],18),window.L.control.scale().addTo(e._map),e.drawUserMarker();var r=l.planOsm,n=l.satEsri;e._map.setMaxBounds(i.MAP_BOUNDS);var a={};if(a["<p>".concat(e.nls.map("planLayerOSM"),"</p>")]=r,a["<p>".concat(e.nls.map("satLayerEsri"),"</p>")]=n,i.getPreference("map-plan-layer"))switch(i.getPreference("map-plan-layer")){case e.nls.map("planLayerOSM"):r.addTo(e._map);break;case e.nls.map("satLayerEsri"):n.addTo(e._map);break;default:r.addTo(e._map)}else r.addTo(e._map);window.L.control.layers(a,{},{position:"bottomright"}).addTo(e._map),e._zoomSlider=new d(e._map),t()}))}},{key:"_initEvents",value:function(){var e=this;return new Promise((function(t){document.getElementById("user-profile").addEventListener("click",e.userProfileModal.bind(e)),document.getElementById("hide-show").addEventListener("click",e.hidShowModal.bind(e)),document.getElementById("center-on").addEventListener("click",e.toggleFocusLock.bind(e)),document.getElementById("overlay").addEventListener("click",e.closeModal.bind(e)),e._map.on("click",e.mapClicked.bind(e)),e._map.on("drag",(function(){e._map.panInsideBounds(i.MAP_BOUNDS,{animate:!0}),"true"===i.getPreference("map-center-on-user")&&e.toggleFocusLock()})),e._map.on("zoomstart",(function(){e._isZooming=!0,"true"===i.getPreference("poi-show-circle")&&(e.setMarkerCircles(e._marks.spot,!1),e.setMarkerCircles(e._marks.store,!1),e.setMarkerCircles(e._marks.bar,!1),e.setMarkerCircles([e._user],!1),e.setMarkerCircles([{circle:e._user.range}],!1))})),e._map.on("zoomend",(function(){e._isZooming=!1,"true"===i.getPreference("poi-show-circle")&&e._map.getZoom()>=15&&(e.setMarkerCircles(e._marks.spot,!0),e.setMarkerCircles(e._marks.store,!0),e.setMarkerCircles(e._marks.bar,!0),e.setMarkerCircles([e._user],!0),e.setMarkerCircles([{circle:e._user.range}],!0)),"true"===i.getPreference("poi-marker-label")&&(e._map.getZoom()<15?(e.setMarkerLabels(e._marks.spot,!1),e.setMarkerLabels(e._marks.store,!1),e.setMarkerLabels(e._marks.bar,!1)):(e.setMarkerLabels(e._marks.spot,!0),e.setMarkerLabels(e._marks.store,!0),e.setMarkerLabels(e._marks.bar,!0))),e.updateDebugUI()})),e._map.on("baselayerchange",(function(e){i.setPreference("map-plan-layer",i.stripDom(e.name))})),t()}))}},{key:"_initMarkers",value:function(){var e=this;return new Promise((function(t){var r={animateAddingMarkers:!0,disableClusteringAtZoom:18,spiderfyOnMaxZoom:!1};e._clusters.spot=new window.L.MarkerClusterGroup(Object.assign(r,{iconCreateFunction:function(e){return window.L.divIcon({className:"cluster-icon-wrapper",html:'\n              <img src="/assets/img/marker/cluster-icon-green.png" class="cluster-icon">\n              <span class="cluster-label">'.concat(e.getChildCount(),"</span>\n            ")})}})),e._clusters.store=new window.L.MarkerClusterGroup(Object.assign(r,{iconCreateFunction:function(e){return window.L.divIcon({className:"cluster-icon-wrapper",html:'\n              <img src="/assets/img/marker/cluster-icon-blue.png" class="cluster-icon">\n              <span class="cluster-label">'.concat(e.getChildCount(),"</span>\n            ")})}})),e._clusters.bar=new window.L.MarkerClusterGroup(Object.assign(r,{iconCreateFunction:function(e){return window.L.divIcon({className:"cluster-icon-wrapper",html:'\n              <img src="/assets/img/marker/cluster-icon-red.png" class="cluster-icon">\n              <span class="cluster-label">'.concat(e.getChildCount(),"</span>\n            ")})}})),"true"===i.getPreference("poi-show-spot")&&e._map.addLayer(e._clusters.spot),"true"===i.getPreference("poi-show-store")&&e._map.addLayer(e._clusters.store),"true"===i.getPreference("poi-show-bar")&&e._map.addLayer(e._clusters.bar);var n=function(t){e.markPopupFactory(t).then((function(r){t.dom=r,t.marker=e.placeMarker(t),e._marks[t.type].push(t),e._clusters[t.type].addLayer(t.marker)}))};i.getSpots().then((function(e){for(var t=0;t<e.length;++t)e[t].type="spot",e[t].user="messmaker",e[t].userId=42,e[t].lat=e[t].latitude,e[t].lng=e[t].longitude,n(e[t])})),i.getStores().then((function(e){for(var t=0;t<e.length;++t)e[t].type="store",e[t].user="messmaker",e[t].userId=42,e[t].lat=e[t].latitude,e[t].lng=e[t].longitude,n(e[t])})),i.getBars().then((function(e){for(var t=0;t<e.length;++t)e[t].type="bar",e[t].user="messmaker",e[t].userId=42,e[t].lat=e[t].latitude,e[t].lng=e[t].longitude,n(e[t])})),t()}))}},{key:"toggleFocusLock",value:function(){"true"===i.getPreference("map-center-on-user")?(this._notification.raise(this.nls.notif("unlockFocusOn")),document.getElementById("center-on").classList.remove("lock-center-on"),i.setPreference("map-center-on-user","false")):(this._notification.raise(this.nls.notif("lockFocusOn")),document.getElementById("center-on").classList.add("lock-center-on"),this._map.flyTo([this._user.lat,this._user.lng],18),i.setPreference("map-center-on-user","true"))}},{key:"toggleLabel",value:function(){var e=!("true"===i.getPreference("poi-marker-label"));this.setMarkerLabels(this._marks.spot,e),this.setMarkerLabels(this._marks.store,e),this.setMarkerLabels(this._marks.bar,e),i.setPreference("poi-marker-label",e)}},{key:"toggleCircle",value:function(){var e=!("true"===i.getPreference("poi-show-circle"));this.setMarkerCircles(this._marks.spot,e),this.setMarkerCircles(this._marks.store,e),this.setMarkerCircles(this._marks.bar,e),this.setMarkerCircles([this._user],e),this.setMarkerCircles([{circle:this._user.range}],e),i.setPreference("poi-show-circle",e)}},{key:"toggleMarkers",value:function(e){var t=!("true"===i.getPreference("poi-show-".concat(e)));!0===t?this._map.addLayer(this._clusters[e]):this._map.removeLayer(this._clusters[e]),i.setPreference("poi-show-".concat(e),t)}},{key:"toggleHighAccuracy",value:function(){var e=!("true"===i.getPreference("map-high-accuracy"));i.setPreference("map-high-accuracy",e),navigator.geolocation.clearWatch(this._watchId),this._initGeolocation().then(this.updateDebugUI.bind(this))}},{key:"toggleDebug",value:function(){var e=!window.DEBUG;window.DEBUG=e,i.setPreference("app-debug",e),e?this.addDebugUI():this.removeDebugUI()}},{key:"newMarkModal",value:function(e){document.getElementById("overlay").appendChild(e),document.getElementById("overlay").style.display="flex",setTimeout((function(){return document.getElementById("overlay").style.opacity=1}),50)}},{key:"editMarkModal",value:function(e){var t=this;i.fetchTemplate("/assets/html/modal/edit".concat(e.type,".html")).then((function(r){var n=r.querySelector("#".concat(e.type,"-name")),o=r.querySelector("#".concat(e.type,"-desc")),c=r.querySelector("#".concat(e.type,"-submit")),s=r.querySelector("#".concat(e.type,"-cancel")),l=r.querySelector("#".concat(e.type,"-rating")),u=new a(l,e.rate);i.replaceString(r.querySelector("#nls-modal-title"),"{{MODAL_TITLE}}",t.nls.modal("".concat(e.type,"EditTitle"))),i.replaceString(r.querySelector("#nls-".concat(e.type,"-name")),"{{".concat(e.type.toUpperCase(),"_NAME}}"),t.nls[e.type]("nameLabel")),i.replaceString(r.querySelector("#nls-".concat(e.type,"-desc")),"{{".concat(e.type.toUpperCase(),"_DESC}}"),t.nls[e.type]("descLabel")),i.replaceString(r.querySelector("#nls-".concat(e.type,"-rate")),"{{".concat(e.type.toUpperCase(),"_RATE}}"),t.nls[e.type]("rateLabel")),i.replaceString(c,"{{".concat(e.type.toUpperCase(),"_SUBMIT}}"),t.nls.nav("add")),i.replaceString(s,"{{".concat(e.type.toUpperCase(),"_CANCEL}}"),t.nls.nav("cancel")),n.value=e.name,o.value=e.description,c.addEventListener("click",(function(){for(var r=0;r<t._marks[e.type].length;++r)if(e.lat===t._marks[e.type][r].lat&&e.lng===t._marks[e.type][r].lng){t._marks[e.type][r].name=n.value,t._marks[e.type][r].description=o.value,t._marks[e.type][r].rate=u.currentRate,e.tooltip.removeFrom(t.map),t.markPopupFactory(e).then((function(t){e.dom=t,e.marker.setPopupContent(e.dom)}));break}for(var a=[],c=0;c<t._marks[e.type].length;++c)a.push(t.formatSavedMarker(t._marks[e.type][c]));i.setPreference("saved-".concat(e.type),JSON.stringify(a)),t._notification.raise(t.nls.notif("".concat(e.type,"Deleted"))),t.closeModal(null,!0)})),s.addEventListener("click",t.closeModal.bind(t,null,!0)),document.getElementById("overlay").appendChild(r),document.getElementById("overlay").style.display="flex",setTimeout((function(){return document.getElementById("overlay").style.opacity=1}),50)}))}},{key:"deleteMarkModal",value:function(e){var t=this;i.fetchTemplate("/assets/html/modal/deletemark.html").then((function(r){i.replaceString(r.querySelector("#nls-modal-title"),"{{MODAL_TITLE}}",t.nls.modal("deleteMarkTitle")),i.replaceString(r.querySelector("#nls-modal-desc"),"{{MODAL_DESC}}",t.nls.modal("deleteMarkDesc")),i.replaceString(r.querySelector("#cancel-close"),"{{MODAL_CANCEL}}",t.nls.nav("cancel")),i.replaceString(r.querySelector("#delete-close"),"{{MODAL_DELETE}}",t.nls.nav("delete")),document.getElementById("overlay").appendChild(r),document.getElementById("overlay").style.display="flex",document.getElementById("cancel-close").addEventListener("click",(function(r){t.closeModal(r),e(!1)}),!1),document.getElementById("delete-close").addEventListener("click",(function(r){t.closeModal(r),e(!0)}),!1),setTimeout((function(){return document.getElementById("overlay").style.opacity=1}),50)}))}},{key:"userProfileModal",value:function(){var e=this;i.fetchTemplate("/assets/html/modal/user.html").then((function(t){i.replaceString(t.querySelector("#nls-modal-title"),"{{MODAL_TITLE}}",e.nls.modal("userTitle")),i.replaceString(t.querySelector("#nls-user-modal-accuracy"),"{{ACCURACY_USER_MODAL}}",e.nls.modal("userAccuracyPref")),i.replaceString(t.querySelector("#nls-user-modal-debug"),"{{DEBUG_USER_MODAL}}",e.nls.modal("userDebugPref")),i.replaceString(t.querySelector("#nls-about-desc"),"{{BEERCRACKERZ_DESC}}",e.nls.modal("aboutDesc")),document.getElementById("overlay").appendChild(t),document.getElementById("overlay").style.display="flex","true"===i.getPreference("map-high-accuracy")&&(document.getElementById("high-accuracy-toggle").checked=!0),!0!==window.DEBUG&&"true"!==i.getPreference("app-debug")||(document.getElementById("debug-toggle").checked=!0),document.getElementById("high-accuracy-toggle").addEventListener("change",e.toggleHighAccuracy.bind(e)),document.getElementById("debug-toggle").addEventListener("change",e.toggleDebug.bind(e)),setTimeout((function(){return document.getElementById("overlay").style.opacity=1}),50)}))}},{key:"hidShowModal",value:function(){var e=this;i.fetchTemplate("/assets/html/modal/hideshow.html").then((function(t){i.replaceString(t.querySelector("#nls-hideshow-modal-title"),"{{MODAL_TITLE}}",e.nls.modal("hideShowTitle")),i.replaceString(t.querySelector("#nls-hideshow-modal-labels"),"{{LABELS_HIDESHOW_MODAL}}",e.nls.modal("hideShowLabels")),i.replaceString(t.querySelector("#nls-hideshow-modal-circles"),"{{CIRCLES_HIDESHOW_MODAL}}",e.nls.modal("hideShowCircles")),i.replaceString(t.querySelector("#nls-hideshow-modal-spots"),"{{SPOTS_HIDESHOW_MODAL}}",e.nls.modal("hideShowSpots")),i.replaceString(t.querySelector("#nls-hideshow-modal-stores"),"{{STORES_HIDESHOW_MODAL}}",e.nls.modal("hideShowStores")),i.replaceString(t.querySelector("#nls-hideshow-modal-bars"),"{{BARS_HIDESHOW_MODAL}}",e.nls.modal("hideShowBars")),i.replaceString(t.querySelector("#modal-close-button"),"{{MODAL_CLOSE}}",e.nls.nav("close")),document.getElementById("overlay").appendChild(t),document.getElementById("overlay").style.display="flex","true"===i.getPreference("poi-marker-label")&&(document.getElementById("label-toggle").checked=!0),"true"===i.getPreference("poi-show-circle")&&(document.getElementById("circle-toggle").checked=!0),"true"===i.getPreference("poi-show-spot")&&(document.getElementById("show-spots").checked=!0),"true"===i.getPreference("poi-show-store")&&(document.getElementById("show-stores").checked=!0),"true"===i.getPreference("poi-show-bar")&&(document.getElementById("show-bars").checked=!0),document.getElementById("label-toggle").addEventListener("change",e.toggleLabel.bind(e)),document.getElementById("circle-toggle").addEventListener("change",e.toggleCircle.bind(e)),document.getElementById("show-spots").addEventListener("change",e.toggleMarkers.bind(e,"spot")),document.getElementById("show-stores").addEventListener("change",e.toggleMarkers.bind(e,"store")),document.getElementById("show-bars").addEventListener("change",e.toggleMarkers.bind(e,"bar")),setTimeout((function(){return document.getElementById("overlay").style.opacity=1}),50)}))}},{key:"closeModal",value:function(e,t){!0!==t&&"overlay"!==e.target.id&&-1===e.target.id.indexOf("close")||(document.getElementById("overlay").style.opacity=0,setTimeout((function(){document.getElementById("overlay").style.display="none",document.getElementById("overlay").innerHTML=""}),300))}},{key:"mapClicked",value:function(e){this._newMarker&&this._newMarker.popupClosed?this._newMarker=null:null!==this._newMarker&&this._newMarker.isBeingDefined||(i.getDistanceBetweenCoords([this._user.lat,this._user.lng],[e.latlng.lat,e.latlng.lng])<i.NEW_MARKER_RANGE?this._newMarker=this.definePOI(e.latlng,this._markerSaved.bind(this)):this._notification.raise(this.nls.notif("newMarkerOutside")))}},{key:"_markerSaved",value:function(e){this._marks[e.type].push(e),this._clusters[e.type].addLayer(e.marker),this._notification.raise(this.nls.notif("".concat(e.type,"Added"))),this.updateMarkerCirclesVisibility(),this._newMarker=null;var t=JSON.parse(i.getPreference("saved-".concat(e.type)))||[];t.push(this.formatSavedMarker(e)),i.setPreference("saved-".concat(e.type),JSON.stringify(t))}},{key:"updateMarkerCirclesVisibility",value:function(){var e=this,t=function(t){for(var r=0;r<t.length;++r)if(e._map.getBounds().contains(t[r].marker.getLatLng())){var n=t[r].marker,a=i.getDistanceBetweenCoords([e._user.lat,e._user.lng],[n.getLatLng().lat,n.getLatLng().lng]);a<i.CIRCLE_RADIUS&&!t[r].circle.visible?(t[r].circle.visible=!0,t[r].circle.setStyle({opacity:1,fillOpacity:.1})):a>=i.CIRCLE_RADIUS&&t[r].circle.visible&&(t[r].circle.visible=!1,t[r].circle.setStyle({opacity:0,fillOpacity:0}))}};"true"===i.getPreference("poi-show-circle")&&(t(this._marks.spot),t(this._marks.store),t(this._marks.bar),t([this._user]))}},{key:"formatSavedMarker",value:function(e){return{type:e.type,lat:e.lat,lng:e.lng,name:e.name,description:e.description,user:e.username||this.user.username,userId:e.userId||this.user.id,dom:null,rate:e.rate,marker:null,circle:null}}},{key:"editMarker",value:function(e){this._map.closePopup(),this.editMarkModal(e)}},{key:"deleteMarker",value:function(e){var t=this;this.deleteMarkModal((function(r){if(!0===r){for(var n=t._marks[e.type],a=0;a<n.length;++a)if(e.lat===n[a].lat&&e.lng===n[a].lng){t.setMarkerCircles([n[a]],!1),t.setMarkerLabels([n[a]],!1),t._clusters[e.type].removeLayer(n[a].marker),n.splice(a,1);break}t._marks[e.type]=n;for(var o=[],c=0;c<t._marks[e.type].length;++c)o.push(t.formatSavedMarker(t._marks[e.type][c]));i.setPreference("saved-".concat(e.type),JSON.stringify(o)),t._notification.raise(t.nls.notif("".concat(e.type,"Deleted")))}}))}},{key:"addDebugUI",value:function(){document.body.appendChild(this._debugElement)}},{key:"removeDebugUI",value:function(){document.body.removeChild(this._debugElement)}},{key:"updateDebugUI",value:function(){var e="true"===i.getPreference("map-high-accuracy")?i.HIGH_ACCURACY:i.OPTIMIZED_ACCURACY;i.updateDebugInterface(this._debugElement,this._user,e)}},{key:"downloadData",value:function(){var e="data:text/json;charset=utf-8,".concat(encodeURIComponent(i.getPreference("saved-spot"))),t=document.createElement("A");t.setAttribute("href",e),t.setAttribute("download","BeerCrackerzData.json"),t.click()}},{key:"map",get:function(){return this._map}},{key:"marks",get:function(){return this._marks}},{key:"user",get:function(){return this._user}},{key:"nls",get:function(){return this._lang}}])&&f(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),s}(s);window.BeerCrackerz=t.default}();